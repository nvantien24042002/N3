<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N3 ‚Äì Vocabulary</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(
          circle at top,
          #eef2ff 0,
          #f4f5fb 55%,
          #e5e7eb 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 14px;
        color: #111827;
      }

      .app {
        width: 100%;
        max-width: 860px;
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 14px 40px rgba(15, 23, 42, 0.18);
        padding: 16px 16px 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .header {
        display: flex;
        flex-direction: column;
        gap: 10px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 10px;
      }

      .title-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .title {
        font-size: 1.08rem;
        font-weight: 800;
        letter-spacing: -0.01em;
      }

      .subtitle {
        margin-top: 3px;
        font-size: 0.86rem;
        color: #6b7280;
      }

      .pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }

      .pills {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4f46e5;
        font-size: 0.78rem;
        font-weight: 700;
        border: 1px solid #e0e7ff;
      }

      .pill.gray {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #374151;
        font-weight: 650;
      }

      .pill.warn {
        background: #fff7ed;
        border-color: #fdba74;
        color: #b45309;
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
      }

      .btn {
        border-radius: 999px;
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        cursor: pointer;
        font-size: 0.86rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: 0.15s;
        white-space: nowrap;
      }

      .btn:hover {
        background: #f3f4ff;
        border-color: #c7d2fe;
        transform: translateY(-1px);
      }

      .btn.primary {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        border: none;
        color: #fff;
        box-shadow: 0 5px 14px rgba(79, 70, 229, 0.35);
      }

      .btn.primary:hover {
        filter: brightness(0.98);
      }

      .btn.danger {
        background: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
      }

      .btn:disabled {
        opacity: 0.55;
        cursor: default;
        transform: none;
      }

      .toggles {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }

      .seg {
        display: inline-flex;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
        background: #f9fafb;
      }

      .seg button {
        border: none;
        background: transparent;
        padding: 7px 10px;
        font-weight: 800;
        font-size: 0.8rem;
        cursor: pointer;
        color: #6b7280;
      }

      .seg button.active {
        background: #4f46e5;
        color: #fff;
      }

      .progress-wrap {
        margin-top: 2px;
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
      }

      .progress {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4f46e5, #22c55e);
        transition: width 0.2s ease;
      }

      .card {
        margin-top: 12px;
        padding: 14px;
        border-radius: 16px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
      }

      .label {
        font-size: 0.78rem;
        color: #6b7280;
        font-weight: 800;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        margin-bottom: 6px;
      }

      .word {
        font-size: 1.22rem;
        font-weight: 900;
        line-height: 1.35;
      }

      .sub {
        margin-top: 6px;
        font-size: 0.92rem;
        color: #4b5563;
      }

      .meta {
        margin-top: 6px;
        font-size: 0.8rem;
        color: #6b7280;
      }

      .options {
        margin-top: 12px;
        display: grid;
        gap: 8px;
      }

      .option-btn {
        width: 100%;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        padding: 10px 12px;
        background: #ffffff;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        transition: background 0.15s ease, transform 0.04s ease,
          border-color 0.12s ease, box-shadow 0.15s ease;
        min-height: 46px; /* mobile tap */
      }

      .option-btn:hover:not(:disabled) {
        background: #f3f4ff;
        border-color: #c7d2fe;
        box-shadow: 0 3px 10px rgba(79, 70, 229, 0.18);
        transform: translateY(-1px);
      }

      .opt-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .opt-key {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        color: #6b7280;
        font-size: 0.8rem;
        font-weight: 900;
        flex: 0 0 auto;
      }

      .opt-main {
        color: #111827;
      }

      .opt-sub {
        font-size: 0.82rem;
        color: #6b7280;
        font-weight: 750;
      }

      .option-btn.correct {
        background: #ecfdf3;
        border-color: #22c55e;
      }

      .option-btn.wrong {
        background: #fef2f2;
        border-color: #f87171;
      }

      .option-btn:disabled {
        cursor: default;
        opacity: 0.95;
        transform: none;
        box-shadow: none;
      }

      .feedback {
        margin-top: 12px;
        display: none;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px dashed #e5e7eb;
        background: #ffffff;
      }

      .fb-title {
        font-weight: 900;
        margin-bottom: 6px;
      }

      .fb-title.ok {
        color: #15803d;
      }

      .fb-title.no {
        color: #b91c1c;
      }

      .fb-line {
        font-size: 0.92rem;
        margin-bottom: 4px;
      }

      .controls {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
      }

      .hint {
        margin-top: 8px;
        font-size: 0.78rem;
        color: #6b7280;
      }

      .stats {
        margin-top: 12px;
        padding: 12px;
        border-radius: 14px;
        background: #ffffff;
        border: 1px dashed #e5e7eb;
      }

      .stats h3 {
        font-size: 0.95rem;
        margin-bottom: 6px;
      }

      .stats p {
        font-size: 0.82rem;
        color: #6b7280;
        margin-bottom: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
      }

      th,
      td {
        padding: 6px 6px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      th {
        background: #f9fafb;
        color: #4b5563;
        font-weight: 900;
      }

      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #fee2e2;
        color: #b91c1c;
        font-weight: 900;
        font-size: 0.72rem;
        margin-left: 6px;
      }

      .footer {
        margin-top: 10px;
        font-size: 0.72rem;
        color: #9ca3af;
        text-align: right;
      }

      /* ====== MODAL (bottom sheet) ====== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(2px);
        display: none;
        justify-content: flex-end;
        align-items: flex-end;
        z-index: 9999;
        padding: 10px;
      }

      .modal-box {
        width: 100%;
        max-width: 760px;
        background: #ffffff;
        border-radius: 18px 18px 0 0;
        padding: 14px 14px 12px;
        box-shadow: 0 -10px 26px rgba(0, 0, 0, 0.22);
        max-height: 86vh;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      .handle {
        width: 44px;
        height: 5px;
        border-radius: 999px;
        background: #d1d5db;
        margin: 0 auto 10px;
      }

      .modal-box h3 {
        font-size: 1rem;
        margin-bottom: 6px;
      }

      .modal-box p {
        font-size: 0.84rem;
        color: #6b7280;
        margin-bottom: 10px;
        line-height: 1.35;
      }

      textarea {
        width: 100%;
        min-height: 170px;
        border-radius: 14px;
        border: 1px solid #d1d5db;
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.85rem;
        background: #f8fafc;
        outline: none;
      }

      textarea:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
        background: #ffffff;
      }

      .modal-actions {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
      }

      @media (max-width: 640px) {
        .app {
          padding: 12px;
          border-radius: 16px;
        }
        .word {
          font-size: 1.08rem;
        }
        .btn {
          padding: 8px 11px;
        }
        .option-btn {
          padding: 10px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="title-row">
          <div>
            <div class="title">Vocabulary Quiz</div>
          </div>

          <div class="toolbar">
            <button class="btn primary" id="btnImportOpen">‚ûï Nh·∫≠p JSON</button>
            <button class="btn" id="btnExportUser">‚¨á Xu·∫•t JSON</button>
            <button class="btn danger" id="btnClearUser">
              üóë Xo√° t·ª´ ƒë√£ nh·∫≠p
            </button>
          </div>
        </div>

        <div class="pill-row">
          <div class="pills">
            <span class="pill gray" id="pillProgress">C√¢u 1 / 50</span>
            <span class="pill gray">Ch∆∞a g·∫∑p: <b id="unseenCount">0</b></span>

            <span class="pill" id="pillMode">Mode A</span>
            <span class="pill warn" id="pillWrong">Sai: 0</span>
            <span class="pill gray"
              >ƒêi·ªÉm: <span id="scoreText">0</span>/<span id="answeredText"
                >0</span
              >
              ¬∑ ƒê√∫ng: <span id="percentText">0</span>%</span
            >
            <span class="pill">
              Sum vocabulary : <b id="totalVocabCount">0</b>
            </span>
          </div>

          <div class="pills">
            <div class="seg" aria-label="modes">
              <button id="btnModeA" class="active" title="A: VI ‚Üí JP">A</button>
              <button id="btnModeB" title="B: JP ‚Üí VI">B</button>
              <button id="btnModeC" title="C: Kana ‚Üí JP">C</button>
            </div>

            <div class="seg" aria-label="session size">
              <button id="btnSize10" title="10 c√¢u">10</button>
              <button id="btnSize20" title="20 c√¢u">20</button>
              <button id="btnSize50" class="active" title="50 c√¢u">50</button>
            </div>
          </div>
        </div>

        <div class="progress-wrap">
          <div class="progress" id="progressBar"></div>
        </div>
      </div>

      <div class="card">
        <div class="label" id="promptLabel">Nghƒ©a ti·∫øng Vi·ªát</div>
        <div class="word" id="wordText">nam gi·ªõi</div>
        <div class="sub" id="subText">Ch·ªçn t·ª´ ti·∫øng Nh·∫≠t t∆∞∆°ng ·ª©ng.</div>
        <div class="meta" id="metaText">Ch·∫ø ƒë·ªô A ¬∑ C√¢u 1 / 50</div>

        <div class="options" id="options"></div>

        <div class="feedback" id="feedback">
          <div class="fb-title" id="fbTitle"></div>
          <div class="fb-line" id="fbRight"></div>
          <div class="fb-line" id="fbJp"></div>
          <div class="fb-line" id="fbVi"></div>
          <div class="fb-line" id="fbSummary"></div>
        </div>

        <div class="controls">
          <button class="btn primary" id="btnNext" disabled>‚û° C√¢u ti·∫øp</button>
          <button class="btn" id="btnReview" disabled>üß™ √în c√¢u sai</button>
          <button class="btn" id="btnRestart">üîÅ L√†m l·∫°i</button>
          <button class="btn" id="btnReviewUser">üìö √în t·ª´ ƒë√£ nh·∫≠p</button>
          <button class="btn danger" id="btnClearWrong">üßπ Xo√° c√¢u sai</button>
        </div>
      </div>

      <div class="stats">
        <h3>Top t·ª´ sai nhi·ªÅu nh·∫•t</h3>
        <p>
          D·ªØ li·ªáu l∆∞u trong tr√¨nh duy·ªát (m·ªói thi·∫øt b·ªã ri√™ng). Import JSON s·∫Ω t·ª±
          g·ªôp v√†o quiz.
        </p>
        <div id="statsBox"></div>
      </div>

      <div class="footer">
        ¬© Nguy·ªÖn VƒÉn Ti·∫øn &amp; ChatGPT ‚Äì Vocabulary Quiz OMEGA
      </div>
    </div>

    <!-- ===== MODAL IMPORT JSON ===== -->
    <div class="modal-overlay" id="modalImport">
      <div class="modal-box">
        <div class="handle"></div>
        <h3>‚ûï Nh·∫≠p JSON t·ª´ v·ª±ng</h3>
        <p>
          V√≠ d·ª•:
          <br />
          <code>
            [{"kanji":"Áî∑ÊÄß","kana":"„Å†„Çì„Åõ„ÅÑ","meaning":"nam
            gi·ªõi","jp":"...","vi":"..."}]
          </code>
        </p>

        <textarea id="importArea" placeholder="D√°n JSON ·ªü ƒë√¢y..."></textarea>

        <div class="modal-actions">
          <div style="display: flex; gap: 8px; flex-wrap: wrap">
            <button class="btn primary" id="btnDoImport">üì• Import</button>
            <button class="btn" id="btnPasteSample">‚ú® D√°n m·∫´u</button>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap">
            <button class="btn" id="btnCloseImport">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**********************
       * 1) DATA DEFAULT
       **********************/
      const vocabDefault = [
        {
          id: 1,
          kanji: "Áî∑ÊÄß",
          kana: "„Å†„Çì„Åõ„ÅÑ",
          meaning: "nam gi·ªõi",
          jp: "„Åù„ÅÆÁî∑ÊÄß„ÅØÂÖàÁîü„Åß„Åô„ÄÇ",
          vi: "Ng∆∞·ªùi ƒë√†n √¥ng ƒë√≥ l√† gi√°o vi√™n„ÄÇ",
        },
        {
          id: 2,
          kanji: "Â•≥ÊÄß",
          kana: "„Åò„Çá„Åõ„ÅÑ",
          meaning: "ph·ª• n·ªØ",
          jp: "„ÅÇ„ÅÆÂ•≥ÊÄß„ÅØ„Åç„Çå„ÅÑ„Åß„Åô„ÄÇ",
          vi: "C√¥ g√°i kia ƒë·∫πp„ÄÇ",
        },
        {
          id: 3,
          kanji: "È´òÈΩ¢",
          kana: "„Åì„ÅÜ„Çå„ÅÑ",
          meaning: "cao tu·ªïi",
          jp: "È´òÈΩ¢„ÅÆ‰∫∫„Å´Â∏≠„Çí„ÇÜ„Åö„Çä„Åæ„Åô„ÄÇ",
          vi: "Nh∆∞·ªùng gh·∫ø cho ng∆∞·ªùi cao tu·ªïi„ÄÇ",
        },
        {
          id: 4,
          kanji: "Âπ¥‰∏ä",
          kana: "„Å®„Åó„ÅÜ„Åà",
          meaning: "ng∆∞·ªùi l·ªõn tu·ªïi h∆°n",
          jp: "ÂΩº„ÅØÁßÅ„Çà„ÇäÂπ¥‰∏ä„Åß„Åô„ÄÇ",
          vi: "Anh ·∫•y l·ªõn tu·ªïi h∆°n t√¥i„ÄÇ",
        },
        {
          id: 5,
          kanji: "ÁõÆ‰∏ä",
          kana: "„ÇÅ„ÅÜ„Åà",
          meaning: "c·∫•p tr√™n",
          jp: "ÁõÆ‰∏ä„ÅÆ‰∫∫„Å´„ÅØ‰∏ÅÂØß„Å´Ë©±„Åó„Åæ„Åô„ÄÇ",
          vi: "N√≥i chuy·ªán l·ªãch s·ª± v·ªõi ng∆∞·ªùi c·∫•p tr√™n„ÄÇ",
        },
        {
          id: 6,
          kanji: "ÂÖàËº©",
          kana: "„Åõ„Çì„Å±„ÅÑ",
          meaning: "ti·ªÅn b·ªëi",
          jp: "ÂÖàËº©„Å´‰ªï‰∫ã„ÇíÊïô„Åà„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åó„Åü„ÄÇ",
          vi: "T√¥i ƒë∆∞·ª£c ƒë√†n anh ch·ªâ vi·ªác„ÄÇ",
        },
        {
          id: 7,
          kanji: "ÂæåËº©",
          kana: "„Åì„ÅÜ„ÅØ„ÅÑ",
          meaning: "h·∫≠u b·ªëi",
          jp: "ÂæåËº©„ÇíÊâã‰ºù„Å£„Å¶„ÅÇ„Åí„Åü„ÄÇ",
          vi: "T√¥i gi√∫p ƒë·ª° ƒë√†n em„ÄÇ",
        },
        {
          id: 8,
          kanji: "‰∏äÂè∏",
          kana: "„Åò„Çá„ÅÜ„Åó",
          meaning: "c·∫•p tr√™n, s·∫øp",
          jp: "‰∏äÂè∏„Å´Áõ∏Ë´á„Åó„Åæ„Åô„ÄÇ",
          vi: "T√¥i h·ªèi √Ω ki·∫øn s·∫øp„ÄÇ",
        },
        {
          id: 9,
          kanji: "Áõ∏Êâã",
          kana: "„ÅÇ„ÅÑ„Å¶",
          meaning: "ƒë·ªëi ph∆∞∆°ng",
          jp: "Áõ∏Êâã„ÅÆÁõÆ„ÇíË¶ã„Å¶Ë©±„Åô„ÄÇ",
          vi: "H√£y nh√¨n v√†o m·∫Øt ƒë·ªëi ph∆∞∆°ng khi n√≥i„ÄÇ",
        },
        {
          id: 10,
          kanji: "Áü•„ÇäÂêà„ÅÑ",
          kana: "„Åó„Çä„ÅÇ„ÅÑ",
          meaning: "ng∆∞·ªùi quen",
          jp: "ÂΩº„ÅØ‰ºöÁ§æ„ÅÆÁü•„ÇäÂêà„ÅÑ„Åß„Åô„ÄÇ",
          vi: "Anh ·∫•y l√† ng∆∞·ªùi quen ·ªü c√¥ng ty„ÄÇ",
        },
        {
          id: 11,
          kanji: "Âèã‰∫∫",
          kana: "„ÇÜ„ÅÜ„Åò„Çì",
          meaning: "b·∫°n th√¢n",
          jp: "Âèã‰∫∫„Å®ÊóÖË°å„Åó„Åæ„Åô„ÄÇ",
          vi: "T√¥i ƒëi du l·ªãch v·ªõi b·∫°n th√¢n„ÄÇ",
        },
        {
          id: 12,
          kanji: "‰ª≤",
          kana: "„Å™„Åã",
          meaning: "m·ªëi quan h·ªá",
          jp: "‰∫å‰∫∫„ÅØ‰ª≤„Åå„ÅÑ„ÅÑ„ÄÇ",
          vi: "Hai ng∆∞·ªùi h·ªç r·∫•t th√¢n„ÄÇ",
        },
        {
          id: 13,
          kanji: "ÁîüÂπ¥ÊúàÊó•",
          kana: "„Åõ„ÅÑ„Å≠„Çì„Åå„Å£„Å¥",
          meaning: "ng√†y th√°ng nƒÉm sinh",
          jp: "ÁîüÂπ¥ÊúàÊó•„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
          vi: "H√£y vi·∫øt ng√†y th√°ng nƒÉm sinh„ÄÇ",
        },
        {
          id: 14,
          kanji: "Ë™ïÁîü",
          kana: "„Åü„Çì„Åò„Çá„ÅÜ",
          meaning: "sinh ra",
          jp: "Â≠ê‰æõ„ÅÆË™ïÁîü„ÇíÁ•ù„ÅÑ„Åæ„Åô„ÄÇ",
          vi: "Ch√∫c m·ª´ng s·ª± ra ƒë·ªùi c·ªßa em b√©„ÄÇ",
        },
        {
          id: 15,
          kanji: "Âπ¥",
          kana: "„Å®„Åó",
          meaning: "nƒÉm, tu·ªïi",
          jp: "Âπ¥„Çí„Å®„Å£„Å¶„ÇÇÂÖÉÊ∞ó„Åß„Åô„ÄÇ",
          vi: "D√π l·ªõn tu·ªïi v·∫´n kh·ªèe„ÄÇ",
        },
        {
          id: 16,
          kanji: "Âá∫Ë∫´",
          kana: "„Åó„ÇÖ„Å£„Åó„Çì",
          meaning: "xu·∫•t th√¢n",
          jp: "ÁßÅ„ÅØ„Éè„Éé„Ç§Âá∫Ë∫´„Åß„Åô„ÄÇ",
          vi: "T√¥i ƒë·∫øn t·ª´ H√† N·ªôi„ÄÇ",
        },
        {
          id: 17,
          kanji: "ÊïÖÈÉ∑",
          kana: "„Åì„Åç„Çá„ÅÜ",
          meaning: "qu√™ h∆∞∆°ng",
          jp: "‰πÖ„Åó„Å∂„Çä„Å´ÊïÖÈÉ∑„Å∏Â∏∞„Å£„Åü„ÄÇ",
          vi: "L√¢u r·ªìi t√¥i m·ªõi v·ªÅ qu√™„ÄÇ",
        },
        {
          id: 18,
          kanji: "ÊàêÈï∑",
          kana: "„Åõ„ÅÑ„Å°„Çá„ÅÜ",
          meaning: "tr∆∞·ªüng th√†nh, ph√°t tri·ªÉn",
          jp: "Â≠ê‰æõ„ÅØÊó©„ÅèÊàêÈï∑„Åó„Åæ„Åô„ÄÇ",
          vi: "Tr·∫ª con l·ªõn nhanh„ÄÇ",
        },
        {
          id: 19,
          kanji: "Êàê‰∫∫",
          kana: "„Åõ„ÅÑ„Åò„Çì",
          meaning: "ng∆∞·ªùi tr∆∞·ªüng th√†nh",
          jp: "ÂΩº„ÅØ‰ªäÂπ¥Êàê‰∫∫„Åó„Åü„ÄÇ",
          vi: "Anh ·∫•y tr∆∞·ªüng th√†nh nƒÉm nay„ÄÇ",
        },
        {
          id: 20,
          kanji: "ÂêàÊ†º",
          kana: "„Åî„ÅÜ„Åã„Åè",
          meaning: "ƒë·ªó, ƒë·∫≠u",
          jp: "Ë©¶È®ì„Å´ÂêàÊ†º„Åó„Åü„ÄÇ",
          vi: "T√¥i ƒë·ªó k·ª≥ thi„ÄÇ",
        },
        {
          id: 21,
          kanji: "ÈÄ≤Â≠¶",
          kana: "„Åó„Çì„Åå„Åè",
          meaning: "h·ªçc l√™n cao",
          jp: "Â§ßÂ≠¶„Å´ÈÄ≤Â≠¶„Åó„Åæ„Åô„ÄÇ",
          vi: "T√¥i h·ªçc l√™n ƒë·∫°i h·ªçc„ÄÇ",
        },
        {
          id: 22,
          kanji: "ÈÄÄÂ≠¶",
          kana: "„Åü„ÅÑ„Åå„Åè",
          meaning: "th√¥i h·ªçc",
          jp: "ÂΩº„ÅØÁóÖÊ∞ó„ÅßÈÄÄÂ≠¶„Åó„Åü„ÄÇ",
          vi: "Anh ·∫•y th√¥i h·ªçc v√¨ b·ªánh„ÄÇ",
        },
        {
          id: 23,
          kanji: "Â∞±ËÅ∑",
          kana: "„Åó„ÇÖ„ÅÜ„Åó„Çá„Åè",
          meaning: "t√¨m vi·ªác, ƒëi l√†m",
          jp: "Â§ßÊâã‰ºöÁ§æ„Å´Â∞±ËÅ∑„Åó„Åü„ÄÇ",
          vi: "T√¥i xin ƒë∆∞·ª£c vi·ªác ·ªü c√¥ng ty l·ªõn„ÄÇ",
        },
        {
          id: 24,
          kanji: "ÈÄÄËÅ∑",
          kana: "„Åü„ÅÑ„Åó„Çá„Åè",
          meaning: "ngh·ªâ vi·ªác",
          jp: "Áà∂„ÅØ‰ªäÂπ¥ÈÄÄËÅ∑„Åô„Çã„ÄÇ",
          vi: "Ba t√¥i ngh·ªâ vi·ªác nƒÉm nay„ÄÇ",
        },
        {
          id: 25,
          kanji: "Â§±Ê•≠",
          kana: "„Åó„Å§„Åé„Çá„ÅÜ",
          meaning: "th·∫•t nghi·ªáp",
          jp: "Â§±Ê•≠„Åó„Å¶Âõ∞„Å£„Å¶„ÅÑ„Çã„ÄÇ",
          vi: "T√¥i th·∫•t nghi·ªáp v√† g·∫∑p kh√≥ khƒÉn„ÄÇ",
        },
        {
          id: 26,
          kanji: "ÊÆãÊ•≠",
          kana: "„Åñ„Çì„Åé„Çá„ÅÜ",
          meaning: "l√†m th√™m",
          jp: "‰ªäÊó•„ÅØÊÆãÊ•≠„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
          vi: "H√¥m nay t√¥i ph·∫£i l√†m th√™m„ÄÇ",
        },
        {
          id: 27,
          kanji: "ÁîüÊ¥ª",
          kana: "„Åõ„ÅÑ„Åã„Å§",
          meaning: "cu·ªôc s·ªëng",
          jp: "Êó•Êú¨„Åß„ÅÆÁîüÊ¥ª„Å´ÊÖ£„Çå„Åü„ÄÇ",
          vi: "T√¥i quen v·ªõi cu·ªôc s·ªëng ·ªü Nh·∫≠t„ÄÇ",
        },
        {
          id: 28,
          kanji: "ÈÄöÂã§",
          kana: "„Å§„ÅÜ„Åç„Çì",
          meaning: "ƒëi l√†m",
          jp: "ÊØéÊó•ÈõªËªä„ÅßÈÄöÂã§„Åó„Å¶„ÅÑ„Çã„ÄÇ",
          vi: "H·∫±ng ng√†y t√¥i ƒëi l√†m b·∫±ng t√†u„ÄÇ",
        },
        {
          id: 29,
          kanji: "Â≠¶Ê≠¥",
          kana: "„Åå„Åè„Çå„Åç",
          meaning: "h·ªçc v·∫•n",
          jp: "Â≠¶Ê≠¥„Çà„ÇäÂÆüÂäõ„ÅåÂ§ß‰∫ã„Å†„ÄÇ",
          vi: "NƒÉng l·ª±c quan tr·ªçng h∆°n h·ªçc v·∫•n„ÄÇ",
        },
        {
          id: 30,
          kanji: "Áµ¶Êñô",
          kana: "„Åç„ÇÖ„ÅÜ„Çä„Çá„ÅÜ",
          meaning: "l∆∞∆°ng",
          jp: "‰ªäÊúà„ÅÆÁµ¶Êñô„Çí„ÇÇ„Çâ„Å£„Åü„ÄÇ",
          vi: "T√¥i ƒë√£ nh·∫≠n l∆∞∆°ng th√°ng n√†y„ÄÇ",
        },
        {
          id: 31,
          kanji: "Èù¢Êé•",
          kana: "„ÇÅ„Çì„Åõ„Å§",
          meaning: "ph·ªèng v·∫•n",
          jp: "‰ªäÊó•„ÅØÈù¢Êé•„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
          vi: "H√¥m nay t√¥i c√≥ ph·ªèng v·∫•n„ÄÇ",
        },
        {
          id: 32,
          kanji: "‰ºëÊÜ©",
          kana: "„Åç„ÇÖ„ÅÜ„Åë„ÅÑ",
          meaning: "ngh·ªâ gi·∫£i lao",
          jp: "Â∞ë„Åó‰ºëÊÜ©„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
          vi: "Ngh·ªâ m·ªôt ch√∫t nh√©„ÄÇ",
        },
        {
          id: 33,
          kanji: "Ë¶≥ÂÖâ",
          kana: "„Åã„Çì„Åì„ÅÜ",
          meaning: "tham quan",
          jp: "‰∫¨ÈÉΩ„ÇíË¶≥ÂÖâ„Åó„Åü„ÅÑ„ÄÇ",
          vi: "T√¥i mu·ªën tham quan Kyoto„ÄÇ",
        },
        {
          id: 34,
          kanji: "Â∏∞ÂõΩ",
          kana: "„Åç„Åì„Åè",
          meaning: "v·ªÅ n∆∞·ªõc",
          jp: "Êù•ÊúàÂ∏∞ÂõΩ„Åó„Åæ„Åô„ÄÇ",
          vi: "Th√°ng sau t√¥i v·ªÅ n∆∞·ªõc„ÄÇ",
        },
        {
          id: 35,
          kanji: "Â∏∞ÁúÅ",
          kana: "„Åç„Åõ„ÅÑ",
          meaning: "v·ªÅ qu√™",
          jp: "Ê≠£Êúà„Å´Â∏∞ÁúÅ„Åó„Åæ„Åô„ÄÇ",
          vi: "T·∫øt t√¥i v·ªÅ qu√™„ÄÇ",
        },
        {
          id: 36,
          kanji: "Â∏∞ÂÆÖ",
          kana: "„Åç„Åü„Åè",
          meaning: "v·ªÅ nh√†",
          jp: "ÊØéÊó•9ÊôÇ„Å´Â∏∞ÂÆÖ„Åô„Çã„ÄÇ",
          vi: "H·∫±ng ng√†y t√¥i v·ªÅ nh√† l√∫c 9 gi·ªù„ÄÇ",
        },
        {
          id: 37,
          kanji: "ÂèÇÂä†",
          kana: "„Åï„Çì„Åã",
          meaning: "tham gia",
          jp: "„Ç§„Éô„É≥„Éà„Å´ÂèÇÂä†„Åó„Åæ„Åô„ÄÇ",
          vi: "T√¥i tham gia s·ª± ki·ªán„ÄÇ",
        },
        {
          id: 38,
          kanji: "Âá∫Â∏≠",
          kana: "„Åó„ÇÖ„Å£„Åõ„Åç",
          meaning: "c√≥ m·∫∑t, tham d·ª±",
          jp: "‰ºöË≠∞„Å´Âá∫Â∏≠„Åó„Åü„ÄÇ",
          vi: "T√¥i c√≥ m·∫∑t trong cu·ªôc h·ªçp„ÄÇ",
        },
        {
          id: 39,
          kanji: "Ê¨†Â∏≠",
          kana: "„Åë„Å£„Åõ„Åç",
          meaning: "v·∫Øng m·∫∑t",
          jp: "‰ªäÊó•„ÅØÊ¨†Â∏≠„Åó„Åæ„Åô„ÄÇ",
          vi: "H√¥m nay t√¥i v·∫Øng m·∫∑t„ÄÇ",
        },
        {
          id: 40,
          kanji: "ÈÅÖÂàª",
          kana: "„Å°„Åì„Åè",
          meaning: "ƒëi tr·ªÖ",
          jp: "ÊéàÊ•≠„Å´ÈÅÖÂàª„Åó„Åü„ÄÇ",
          vi: "T√¥i ƒëi h·ªçc tr·ªÖ„ÄÇ",
        },
        {
          id: 41,
          kanji: "ÂåñÁ≤ß",
          kana: "„Åë„Åó„Çá„ÅÜ",
          meaning: "trang ƒëi·ªÉm",
          jp: "ÊØéÊúùÂåñÁ≤ß„Çí„Åó„Åæ„Åô„ÄÇ",
          vi: "T√¥i trang ƒëi·ªÉm m·ªói s√°ng„ÄÇ",
        },
        {
          id: 42,
          kanji: "Ë®àÁÆó",
          kana: "„Åë„ÅÑ„Åï„Çì",
          meaning: "t√≠nh to√°n",
          jp: "ÊñôÈáë„ÇíË®àÁÆó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
          vi: "H√£y t√≠nh ti·ªÅn gi√∫p t√¥i„ÄÇ",
        },
        {
          id: 43,
          kanji: "Ë®àÁîª",
          kana: "„Åë„ÅÑ„Åã„Åè",
          meaning: "k·∫ø ho·∫°ch",
          jp: "ÊóÖË°å„ÅÆË®àÁîª„ÇíÁ´ã„Å¶„Çã„ÄÇ",
          vi: "L·∫≠p k·∫ø ho·∫°ch du l·ªãch„ÄÇ",
        },
        {
          id: 44,
          kanji: "ÊàêÂäü",
          kana: "„Åõ„ÅÑ„Åì„ÅÜ",
          meaning: "th√†nh c√¥ng",
          jp: "Ë®àÁîª„ÅØÊàêÂäü„Åó„Åü„ÄÇ",
          vi: "K·∫ø ho·∫°ch ƒë√£ th√†nh c√¥ng„ÄÇ",
        },
        {
          id: 45,
          kanji: "Â§±Êïó",
          kana: "„Åó„Å£„Å±„ÅÑ",
          meaning: "th·∫•t b·∫°i",
          jp: "„ÉÜ„Çπ„Éà„ÅßÂ§±Êïó„Åó„Åü„ÄÇ",
          vi: "T√¥i th·∫•t b·∫°i trong b√†i ki·ªÉm tra„ÄÇ",
        },
        {
          id: 46,
          kanji: "Ê∫ñÂÇô",
          kana: "„Åò„ÇÖ„Çì„Å≥",
          meaning: "chu·∫©n b·ªã",
          jp: "‰ºöË≠∞„ÅÆÊ∫ñÂÇô„Çí„Åô„Çã„ÄÇ",
          vi: "Chu·∫©n b·ªã cho cu·ªôc h·ªçp„ÄÇ",
        },
        {
          id: 47,
          kanji: "Êï¥ÁêÜ",
          kana: "„Åõ„ÅÑ„Çä",
          meaning: "s·∫Øp x·∫øp",
          jp: "Êú∫„ÇíÊï¥ÁêÜ„Åó„Åü„ÄÇ",
          vi: "T√¥i s·∫Øp x·∫øp b√†n l√†m vi·ªác„ÄÇ",
        },
        {
          id: 48,
          kanji: "Ê≥®Êñá",
          kana: "„Å°„ÇÖ„ÅÜ„ÇÇ„Çì",
          meaning: "g·ªçi m√≥n, ƒë·∫∑t h√†ng",
          jp: "„Ç≥„Éº„Éí„Éº„ÇíÊ≥®Êñá„Åó„Åü„ÄÇ",
          vi: "T√¥i g·ªçi c√† ph√™„ÄÇ",
        },
        {
          id: 49,
          kanji: "Ë≤ØÈáë",
          kana: "„Å°„Çá„Åç„Çì",
          meaning: "ti·∫øt ki·ªám ti·ªÅn",
          jp: "ÊØéÊúàË≤ØÈáë„Åó„Å¶„ÅÑ„Çã„ÄÇ",
          vi: "T√¥i ti·∫øt ki·ªám m·ªói th√°ng„ÄÇ",
        },
        {
          id: 50,
          kanji: "ÂæπÂ§ú",
          kana: "„Å¶„Å§„ÇÑ",
          meaning: "th·ª©c khuya, th·ª©c tr·∫Øng ƒë√™m",
          jp: "Êò®Êó•„ÅØÂæπÂ§ú„Åó„Åü„ÄÇ",
          vi: "T√¥i ƒë√£ th·ª©c tr·∫Øng ƒë√™m h√¥m qua„ÄÇ",
        },
      ];

      /**********************
       * 2) STORAGE KEYS
       **********************/
      const USER_KEY = "MIMI_N3_VOCAB_USER_V1";
      const WRONG_KEY = "MIMI_N3_VOCAB_WRONG_V1"; // { A: [id...], B: [id...], C:[id...] }
      const STATS_KEY = "MIMI_N3_VOCAB_STATS_V1"; // { [id]: { attempts, wrongs } }
      const SEEN_KEY = "MIMI_N3_VOCAB_SEEN_V1"; // { [id]: true }

      /**********************
       * 3) STATE
       **********************/
      let mode = "A"; // A/B/C
      let sessionSize = 50; // 10/20/50
      let inReview = false;
      let reviewType = "ALL"; // ALL | WRONG | USER

      let vocabUser = [];
      let vocabAll = [];

      let orderIds = [];
      let idx = 0;

      let score = 0;
      let answered = 0;
      let locked = false;

      // DOM
      const wordText = document.getElementById("wordText");
      const subText = document.getElementById("subText");
      const promptLabel = document.getElementById("promptLabel");
      const metaText = document.getElementById("metaText");
      const optionsEl = document.getElementById("options");
      const feedbackEl = document.getElementById("feedback");
      const fbTitle = document.getElementById("fbTitle");
      const fbRight = document.getElementById("fbRight");
      const fbJp = document.getElementById("fbJp");
      const fbVi = document.getElementById("fbVi");
      const fbSummary = document.getElementById("fbSummary");

      const pillProgress = document.getElementById("pillProgress");
      const pillMode = document.getElementById("pillMode");
      const pillWrong = document.getElementById("pillWrong");
      const scoreText = document.getElementById("scoreText");
      const answeredText = document.getElementById("answeredText");
      const percentText = document.getElementById("percentText");

      const btnNext = document.getElementById("btnNext");
      const btnReview = document.getElementById("btnReview");
      const btnRestart = document.getElementById("btnRestart");
      const btnClearWrong = document.getElementById("btnClearWrong");

      const btnModeA = document.getElementById("btnModeA");
      const btnModeB = document.getElementById("btnModeB");
      const btnModeC = document.getElementById("btnModeC");

      const btnSize10 = document.getElementById("btnSize10");
      const btnSize20 = document.getElementById("btnSize20");
      const btnSize50 = document.getElementById("btnSize50");

      const progressBar = document.getElementById("progressBar");

      const statsBox = document.getElementById("statsBox");

      // modal import
      const modalImport = document.getElementById("modalImport");
      const importArea = document.getElementById("importArea");
      const btnImportOpen = document.getElementById("btnImportOpen");
      const btnCloseImport = document.getElementById("btnCloseImport");
      const btnDoImport = document.getElementById("btnDoImport");
      const btnPasteSample = document.getElementById("btnPasteSample");

      const btnExportUser = document.getElementById("btnExportUser");
      const btnClearUser = document.getElementById("btnClearUser");

      /**********************
       * 4) HELPERS
       **********************/
      function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function nowId() {
        return "u-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
      }

      function safeJSONParse(raw, fallback) {
        try {
          return JSON.parse(raw);
        } catch {
          return fallback;
        }
      }

      function loadUserVocab() {
        const raw = localStorage.getItem(USER_KEY);
        const parsed = raw ? safeJSONParse(raw, []) : [];
        return Array.isArray(parsed) ? parsed : [];
      }

      function saveUserVocab(list) {
        localStorage.setItem(USER_KEY, JSON.stringify(list));
      }

      function loadWrongMap() {
        const raw = localStorage.getItem(WRONG_KEY);
        const parsed = raw
          ? safeJSONParse(raw, { A: [], B: [], C: [] })
          : { A: [], B: [], C: [] };
        return {
          A: Array.isArray(parsed.A) ? parsed.A : [],
          B: Array.isArray(parsed.B) ? parsed.B : [],
          C: Array.isArray(parsed.C) ? parsed.C : [],
        };
      }

      function saveWrongMap(map) {
        localStorage.setItem(WRONG_KEY, JSON.stringify(map));
      }

      function loadStatsMap() {
        const raw = localStorage.getItem(STATS_KEY);
        const parsed = raw ? safeJSONParse(raw, {}) : {};
        return parsed && typeof parsed === "object" ? parsed : {};
      }
      function loadSeenMap() {
        const raw = localStorage.getItem(SEEN_KEY);
        const parsed = raw ? safeJSONParse(raw, {}) : {};
        return parsed && typeof parsed === "object" ? parsed : {};
      }

      function markSeen(id) {
        const seen = loadSeenMap();
        seen[String(id)] = true;
        localStorage.setItem(SEEN_KEY, JSON.stringify(seen));
      }

      function isSeen(id) {
        const seen = loadSeenMap();
        return !!seen[String(id)];
      }

      function saveStatsMap(map) {
        localStorage.setItem(STATS_KEY, JSON.stringify(map));
      }

      function rebuildVocabAll() {
        vocabUser = loadUserVocab();
        vocabAll = [...vocabDefault, ...vocabUser]
          .map((x) => ({
            id: x.id ?? nowId(),
            kanji: String(x.kanji ?? "").trim(),
            kana: String(x.kana ?? "").trim(),
            meaning: String(x.meaning ?? "").trim(),
            jp: String(x.jp ?? "").trim(),
            vi: String(x.vi ?? "").trim(),
          }))
          .filter((x) => x.kanji && x.meaning);

        updateTotalVocabUI();
        updateUnseenUI();
      }

      function findById(id) {
        return vocabAll.find((v) => String(v.id) === String(id));
      }

      function updateModeUI() {
        btnModeA.classList.toggle("active", mode === "A");
        btnModeB.classList.toggle("active", mode === "B");
        btnModeC.classList.toggle("active", mode === "C");

        // pillMode.textContent = inReview
        //   ? `Mode ${mode} ¬∑ Review`
        //   : `Mode ${mode}`;
        pillMode.textContent =
          reviewType === "USER"
            ? `Mode ${mode} ¬∑ User`
            : inReview
            ? `Mode ${mode} ¬∑ Review`
            : `Mode ${mode}`;
      }
      function updateTotalVocabUI() {
        document.getElementById("totalVocabCount").textContent =
          vocabAll.length;
      }
      function updateSizeUI() {
        btnSize10.classList.toggle("active", sessionSize === 10);
        btnSize20.classList.toggle("active", sessionSize === 20);
        btnSize50.classList.toggle("active", sessionSize === 50);
      }

      function updateScoreUI() {
        scoreText.textContent = String(score);
        answeredText.textContent = String(answered);
        const pct = answered === 0 ? 0 : Math.round((score / answered) * 100);
        percentText.textContent = String(pct);
      }

      function updateProgressUI() {
        const total = orderIds.length || 1;
        const n = Math.min(idx + 1, total);
        pillProgress.textContent =
          idx >= total ? "Xong ‚úî" : `C√¢u ${n} / ${total}`;
        const pct = (idx / total) * 100;
        progressBar.style.width = pct + "%";
        metaText.textContent =
          (inReview ? "Review ¬∑ " : "") +
          `Ch·∫ø ƒë·ªô ${mode} ¬∑ C√¢u ${n} / ${total}`;
      }

      function getWrongCountForMode() {
        const m = loadWrongMap();
        return new Set(m[mode] || []).size;
      }

      function syncWrongPillAndReviewBtn() {
        const c = getWrongCountForMode();
        pillWrong.textContent = `Sai: ${c}`;
        btnReview.disabled = c === 0;
      }

      function setLocked(value) {
        locked = value;
      }

      function getPromptAndOptions(correctId) {
        const correct = findById(correctId);
        if (!correct) return null;

        // pick 3 wrong
        const sourcePool = reviewType === "USER" ? vocabUser : vocabAll;
        const pool = sourcePool.filter(
          (v) => String(v.id) !== String(correctId)
        );
        const wrongs = shuffle(pool).slice(0, Math.min(3, pool.length));

        let prompt = "";
        let label = "";
        let subtitle = "";
        let options = [];

        if (mode === "A") {
          // VI -> JP
          label = "Nghƒ©a ti·∫øng Vi·ªát";
          prompt = correct.meaning;
          subtitle = "Ch·ªçn t·ª´ ti·∫øng Nh·∫≠t t∆∞∆°ng ·ª©ng.";
          options = shuffle([correct, ...wrongs]).map((v) => ({
            id: v.id,
            main: v.kanji,
            sub: v.kana ? `(${v.kana})` : "",
          }));
        } else if (mode === "B") {
          // JP -> VI
          label = "T·ª´ ti·∫øng Nh·∫≠t";
          prompt = `${correct.kanji}${
            correct.kana ? "Ôºà" + correct.kana + "Ôºâ" : ""
          }`;
          subtitle = "Ch·ªçn nghƒ©a ti·∫øng Vi·ªát ƒë√∫ng.";
          options = shuffle([correct, ...wrongs]).map((v) => ({
            id: v.id,
            main: v.meaning,
            sub: "",
          }));
        } else {
          // C: Kana -> JP
          label = "C√°ch ƒë·ªçc (Kana)";
          prompt = correct.kana || "(kh√¥ng c√≥ kana)";
          subtitle = "Ch·ªçn ch·ªØ Kanji ƒë√∫ng.";
          options = shuffle([correct, ...wrongs]).map((v) => ({
            id: v.id,
            main: v.kanji,
            sub: v.meaning ? `‚Äì ${v.meaning}` : "",
          }));
        }

        return { correct, prompt, label, subtitle, options };
      }
      function countUnseenVocab() {
        const seen = loadSeenMap();
        return vocabAll.filter((v) => !seen[String(v.id)]).length;
      }

      function updateUnseenUI() {
        document.getElementById("unseenCount").textContent = countUnseenVocab();
      }

      function renderQuestion() {
        feedbackEl.style.display = "none";
        fbTitle.textContent = "";
        fbRight.textContent = "";
        fbJp.textContent = "";
        fbVi.textContent = "";
        fbSummary.textContent = "";
        btnNext.disabled = true;
        setLocked(false);

        if (idx >= orderIds.length) {
          // end
          wordText.textContent = inReview
            ? "ƒê√£ √¥n xong to√†n b·ªô c√¢u sai c·ªßa ch·∫ø ƒë·ªô n√†y ‚úÖ"
            : "Ho√†n th√†nh phi√™n hi·ªán t·∫°i ‚úÖ";
          promptLabel.textContent = "Ho√†n t·∫•t";
          subText.textContent =
            getWrongCountForMode() > 0
              ? "B·∫°n c√≥ th·ªÉ b·∫•m ‚Äú√în c√¢u sai‚Äù ƒë·ªÉ luy·ªán ri√™ng."
              : "Kh√¥ng c√≤n c√¢u sai n√†o cho ch·∫ø ƒë·ªô n√†y. Qu√° ƒë·ªânh!";
          optionsEl.innerHTML = "";
          feedbackEl.style.display = "block";
          fbTitle.textContent = "T·ªïng k·∫øt";
          fbTitle.className = "fb-title ok";
          fbSummary.textContent =
            "ƒêi·ªÉm: " +
            score +
            "/" +
            answered +
            " (" +
            percentText.textContent +
            "%).";
          updateProgressUI();
          return;
        }

        const correctId = orderIds[idx];
        const built = getPromptAndOptions(correctId);
        if (!built) {
          idx++;
          renderQuestion();
          return;
        }

        promptLabel.textContent = built.label;
        wordText.textContent = built.prompt;
        subText.textContent = built.subtitle;

        optionsEl.innerHTML = "";
        const keys = ["A", "B", "C", "D"];

        built.options.forEach((opt, i) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.dataset.optId = String(opt.id);
          const isUserWord = vocabUser.some(
            (v) => String(v.id) === String(opt.id)
          );
          const showNew = isUserWord && !isSeen(opt.id);

          btn.innerHTML = `
            <div class="opt-left">
              <div class="opt-key">${keys[i]}</div>
              <div class="opt-main">
                ${opt.main}
                ${showNew ? '<span class="tag">NEW</span>' : ""}
              </div>
            </div>
            <div class="opt-sub">${opt.sub || ""}</div>
          `;

          btn.addEventListener("click", () =>
            handleAnswer(opt.id, built.correct.id, built.correct)
          );
          optionsEl.appendChild(btn);
        });

        updateProgressUI();
      }

      function bumpStats(correctId, isCorrect) {
        const stats = loadStatsMap();
        const key = String(correctId);
        if (!stats[key]) stats[key] = { attempts: 0, wrongs: 0 };
        stats[key].attempts++;
        if (!isCorrect) stats[key].wrongs++;
        saveStatsMap(stats);
      }

      function addWrong(correctId) {
        const wm = loadWrongMap();
        const set = new Set(wm[mode] || []);
        set.add(String(correctId));
        wm[mode] = Array.from(set);
        saveWrongMap(wm);
      }

      function removeWrong(correctId) {
        const wm = loadWrongMap();
        const set = new Set(wm[mode] || []);
        set.delete(String(correctId));
        wm[mode] = Array.from(set);
        saveWrongMap(wm);
      }

      function handleAnswer(chosenId, correctId, correctItem) {
        markSeen(correctId);
        if (locked) return;
        setLocked(true);

        answered++;

        const isCorrect = String(chosenId) === String(correctId);
        if (isCorrect) score++;

        bumpStats(correctId, isCorrect);

        if (isCorrect) {
          if (inReview) removeWrong(correctId);
        } else {
          if (!inReview) addWrong(correctId);
          if (inReview) addWrong(correctId); // v·∫´n sai th√¨ gi·ªØ l·∫°i
        }

        // disable & paint
        const buttons = optionsEl.querySelectorAll("button");
        buttons.forEach((b) => (b.disabled = true));
        buttons.forEach((b) => {
          const id = b.dataset.optId;
          if (String(id) === String(correctId)) b.classList.add("correct");
          else if (String(id) === String(chosenId) && !isCorrect)
            b.classList.add("wrong");
        });

        // feedback
        feedbackEl.style.display = "block";
        if (isCorrect) {
          fbTitle.textContent = "ƒê√∫ng r·ªìi! ‚ú®";
          fbTitle.className = "fb-title ok";
        } else {
          fbTitle.textContent = "Sai r·ªìi üò≠";
          fbTitle.className = "fb-title no";
        }

        const rightText =
          mode === "A"
            ? `${correctItem.kanji}${
                correctItem.kana ? "Ôºà" + correctItem.kana + "Ôºâ" : ""
              }`
            : mode === "B"
            ? `${correctItem.meaning}`
            : `${correctItem.kanji}`;

        fbRight.textContent = `ƒê√°p √°n ƒë√∫ng: „Äå${rightText}„Äç`;
        fbJp.textContent = correctItem.jp ? `‰æãÊñáÔºö${correctItem.jp}` : "";
        fbVi.textContent = correctItem.vi ? `D·ªãchÔºö${correctItem.vi}` : "";

        syncWrongPillAndReviewBtn();
        updateScoreUI();

        const remain = getWrongCountForMode();
        fbSummary.textContent =
          remain > 0
            ? `C√≤n ${remain} t·ª´ ƒëang n·∫±m trong danh s√°ch sai c·ªßa Mode ${mode}.`
            : `Kh√¥ng c√≤n t·ª´ sai n√†o trong Mode ${mode}. Tuy·ªát v·ªùi!`;

        btnNext.disabled = false;
        markSeen(correctId);
        updateUnseenUI();
      }

      function startSession(review = false) {
        inReview = review;
        updateModeUI();

        let ids = [];

        if (reviewType === "USER") {
          // ‚≠ê ch·ªâ l·∫•y vocab user
          ids = vocabUser.map((v) => String(v.id));
        } else if (reviewType === "WRONG") {
          const wm = loadWrongMap();
          ids = wm[mode] || [];
        } else {
          // ALL
          ids = vocabAll.map((v) => String(v.id));
        }

        if (!review && reviewType === "ALL") {
          ids = shuffle(ids).slice(0, Math.min(sessionSize, ids.length));
        } else {
          ids = shuffle(ids);
        }

        orderIds = ids;
        idx = 0;
        score = 0;
        answered = 0;

        updateScoreUI();
        syncWrongPillAndReviewBtn();
        renderQuestion();
      }

      function refreshStatsUI() {
        const stats = loadStatsMap();
        const rows = Object.entries(stats)
          .map(([id, st]) => ({
            id,
            attempts: st.attempts || 0,
            wrongs: st.wrongs || 0,
          }))
          .filter((x) => x.wrongs > 0)
          .sort((a, b) => {
            if (b.wrongs !== a.wrongs) return b.wrongs - a.wrongs;
            return b.attempts - a.attempts;
          })
          .slice(0, 6);

        if (rows.length === 0) {
          statsBox.innerHTML =
            '<div style="font-size:0.86rem;color:#9ca3af;font-style:italic;">Ch∆∞a c√≥ d·ªØ li·ªáu sai. L√†m quiz v√†i c√¢u l√† s·∫Ω c√≥ th·ªëng k√™ nh√©.</div>';
          return;
        }

        let html =
          "<table><thead><tr><th>#</th><th>JP</th><th>VI</th><th>Sai/T·ªïng</th><th>T·ªâ l·ªá</th></tr></thead><tbody>";
        rows.forEach((r, i) => {
          const v = findById(r.id);
          if (!v) return;
          const rate =
            r.attempts === 0 ? 0 : Math.round((r.wrongs / r.attempts) * 100);
          html += `<tr>
            <td>${i + 1}</td>
            <td>${v.kanji}${v.kana ? "Ôºà" + v.kana + "Ôºâ" : ""}</td>
            <td>${v.meaning}</td>
            <td>${r.wrongs}/${r.attempts}</td>
            <td>${rate}%${
            rate >= 50 ? ' <span class="tag">c·∫ßn √¥n</span>' : ""
          }</td>
          </tr>`;
        });
        html += "</tbody></table>";
        statsBox.innerHTML = html;
      }

      /**********************
       * 5) IMPORT JSON
       **********************/
      function openModal() {
        modalImport.style.display = "flex";
      }

      function closeModal() {
        modalImport.style.display = "none";
      }

      function normalizeImportedItem(raw) {
        // ch·∫•p nh·∫≠n nhi·ªÅu t√™n field (ƒë·ª° ƒëau ƒë·∫ßu khi copy)
        const kanji = (raw.kanji ?? raw.word ?? raw.jpWord ?? "")
          .toString()
          .trim();
        const kana = (raw.kana ?? raw.reading ?? raw.kanaReading ?? "")
          .toString()
          .trim();
        const meaning = (raw.meaning ?? raw.viMeaning ?? raw.translation ?? "")
          .toString()
          .trim();
        const jp = (raw.jp ?? raw.exampleJP ?? "").toString().trim();
        const vi = (raw.vi ?? raw.exampleVI ?? "").toString().trim();

        if (!kanji || !meaning) return null;

        return {
          id: raw.id ? String(raw.id) : nowId(),
          kanji,
          kana,
          meaning,
          jp,
          vi,
        };
      }

      function doImport() {
        const text = importArea.value.trim();
        if (!text) {
          alert("B·∫°n ch∆∞a d√°n JSON.");
          return;
        }

        const parsed = safeJSONParse(text, null);
        if (!parsed || !Array.isArray(parsed)) {
          alert("JSON kh√¥ng h·ª£p l·ªá. B·∫°n ph·∫£i d√°n d·∫°ng m·∫£ng: [ {...}, {...} ]");
          return;
        }

        const normalized = [];
        parsed.forEach((it) => {
          const n = normalizeImportedItem(it);
          if (n) normalized.push(n);
        });

        if (normalized.length === 0) {
          alert("Kh√¥ng import ƒë∆∞·ª£c item n√†o. C·∫ßn t·ªëi thi·ªÉu kanji + meaning.");
          return;
        }

        // tr√°nh tr√πng theo kanji+kana+meaning
        const existed = loadUserVocab();
        const keyOf = (x) =>
          `${x.kanji}__${x.kana}__${x.meaning}`.toLowerCase();
        const existedKeys = new Set(existed.map(keyOf));

        const merged = [...existed];
        let added = 0;

        normalized.forEach((n) => {
          const k = keyOf(n);
          if (!existedKeys.has(k)) {
            merged.push(n);
            existedKeys.add(k);
            added++;
          }
        });

        saveUserVocab(merged);
        rebuildVocabAll();
        refreshStatsUI();
        syncWrongPillAndReviewBtn();

        alert(
          `‚úÖ Import xong! ƒê√£ th√™m m·ªõi: ${added} t·ª´. (T·ªïng user vocab: ${merged.length})`
        );
        closeModal();
        startSession(false);
        updateUnseenUI();
      }

      /**********************
       * 6) EVENTS
       **********************/
      const btnReviewUser = document.getElementById("btnReviewUser");

      btnReviewUser.addEventListener("click", () => {
        if (vocabUser.length === 0) {
          alert("‚ö†Ô∏è B·∫°n ch∆∞a import t·ª´ v·ª±ng n√†o.");
          return;
        }
        reviewType = "USER";
        startSession(true);
      });
      btnRestart.addEventListener("click", () => {
        reviewType = "ALL";
        startSession(false);
      });
      btnModeA.addEventListener("click", () => {
        mode = "A";
        inReview = false;
        updateModeUI();
        syncWrongPillAndReviewBtn();
        startSession(false);
      });
      btnModeB.addEventListener("click", () => {
        mode = "B";
        inReview = false;
        updateModeUI();
        syncWrongPillAndReviewBtn();
        startSession(false);
      });
      btnModeC.addEventListener("click", () => {
        mode = "C";
        inReview = false;
        updateModeUI();
        syncWrongPillAndReviewBtn();
        startSession(false);
      });

      btnSize10.addEventListener("click", () => {
        sessionSize = 10;
        updateSizeUI();
        startSession(false);
      });
      btnSize20.addEventListener("click", () => {
        sessionSize = 20;
        updateSizeUI();
        startSession(false);
      });
      btnSize50.addEventListener("click", () => {
        sessionSize = 50;
        updateSizeUI();
        startSession(false);
      });

      btnNext.addEventListener("click", () => {
        if (idx < orderIds.length) {
          idx++;
          renderQuestion();
        }
      });

      btnRestart.addEventListener("click", () => {
        startSession(false);
      });

      btnReview.addEventListener("click", () => {
        reviewType = "WRONG";
        startSession(true);
      });

      btnClearWrong.addEventListener("click", () => {
        if (!confirm(`Xo√° to√†n b·ªô c√¢u sai c·ªßa Mode ${mode}?`)) return;
        const wm = loadWrongMap();
        wm[mode] = [];
        saveWrongMap(wm);
        syncWrongPillAndReviewBtn();
        alert("‚úÖ ƒê√£ xo√° c√¢u sai.");
      });

      // keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        const key = e.key.toLowerCase();
        const buttons = optionsEl.querySelectorAll("button");
        if (!buttons.length) return;

        if (["a", "b", "c", "d"].includes(key)) {
          const k = key.charCodeAt(0) - 97; // a -> 0
          if (buttons[k] && !buttons[k].disabled) buttons[k].click();
        } else if (key === "enter") {
          if (!btnNext.disabled) btnNext.click();
        }
      });

      // import modal
      btnImportOpen.addEventListener("click", openModal);
      btnCloseImport.addEventListener("click", closeModal);
      btnDoImport.addEventListener("click", doImport);

      btnPasteSample.addEventListener("click", () => {
        const sample = [
          {
            kanji: "ÈùûÂ∏∏Âè£",
            kana: "„Å≤„Åò„Çá„ÅÜ„Åê„Å°",
            meaning: "c·ª≠a tho√°t hi·ªÉm",
            jp: "ÈùûÂ∏∏Âè£„ÅØ„Å©„Åì„Åß„Åô„Åã„ÄÇ",
            vi: "L·ªëi tho√°t hi·ªÉm ·ªü ƒë√¢u?",
          },
          {
            kanji: "Êó•Â∏∏",
            kana: "„Å´„Å°„Åò„Çá„ÅÜ",
            meaning: "th∆∞·ªùng ng√†y, h·∫±ng ng√†y",
            jp: "Êó•Â∏∏„ÅÆÁîüÊ¥ª„ÅØÂ§ßÂàá„Åß„Åô„ÄÇ",
            vi: "Cu·ªôc s·ªëng h·∫±ng ng√†y r·∫•t quan tr·ªçng.",
          },
        ];
        importArea.value = JSON.stringify(sample, null, 2);
      });

      // click outside to close
      modalImport.addEventListener("click", (e) => {
        if (e.target === modalImport) closeModal();
      });

      // export / clear user
      btnExportUser.addEventListener("click", () => {
        const u = loadUserVocab();
        const json = JSON.stringify(u, null, 2);
        // copy n·∫øu ƒë∆∞·ª£c
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(json).then(
            () => alert("‚úÖ ƒê√£ copy JSON (t·ª´ ƒë√£ nh·∫≠p) v√†o clipboard!"),
            () => alert("M·ªü console ƒë·ªÉ copy tay.")
          );
        } else {
          alert(
            "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ clipboard. B·∫°n c√≥ th·ªÉ copy trong localStorage."
          );
        }
        // ƒë·ªìng th·ªùi m·ªü modal ƒë·ªÉ d√°n/nh√¨n
        openModal();
        importArea.value = json;
      });

      btnClearUser.addEventListener("click", () => {
        const u = loadUserVocab();
        if (u.length === 0) {
          alert("Kh√¥ng c√≥ t·ª´ user n√†o ƒë·ªÉ xo√°.");
          return;
        }
        if (
          !confirm(
            "Xo√° TO√ÄN B·ªò t·ª´ b·∫°n ƒë√£ import? (Kh√¥ng ·∫£nh h∆∞·ªüng data m·∫∑c ƒë·ªãnh)"
          )
        )
          return;
        localStorage.removeItem(USER_KEY);
        rebuildVocabAll();
        refreshStatsUI();
        alert("‚úÖ ƒê√£ xo√° to√†n b·ªô user vocab.");
        startSession(false);
      });

      /**********************
       * 7) START
       **********************/
      rebuildVocabAll();
      updateModeUI();
      updateSizeUI();
      refreshStatsUI();
      syncWrongPillAndReviewBtn();
      updateScoreUI();
      startSession(false);
    </script>
  </body>
</html>
