<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>N3 Super Quiz OMEGA ‚Äì Kanji + Compounds + Auto Add</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      /* =============== GLOBAL =============== */
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
          sans-serif;
        background: radial-gradient(
          circle at top,
          #eef2ff 0,
          #f3f4f6 45%,
          #e5e7eb 100%
        );
        color: #111827;
      }

      .wrapper {
        max-width: 1000px;
        margin: 32px auto;
        background: #ffffff;
        padding: 24px 24px 28px;
        border-radius: 22px;
        box-shadow: 0 20px 48px rgba(15, 23, 42, 0.15);
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: -0.02em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      h1 span.logo-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(135deg, #6366f1, #ec4899);
        display: inline-block;
      }

      .subtitle {
        margin: 4px 0 16px;
        color: #6b7280;
        font-size: 14px;
      }

      /* =============== HEADER + SCORE + REVIEW BTN =============== */
      .header-row-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-top: 12px;
        margin-bottom: 4px;
        flex-wrap: wrap;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
      }

      .score-box {
        font-size: 13px;
        background: #f9fafb;
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
      }

      .pill-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        color: #374151;
        transition: 0.15s;
      }

      .pill-btn:hover {
        background: #eef2ff;
      }

      .pill-btn.primary {
        background: #eef2ff;
        border-color: #6366f1;
        color: #1f2937;
      }

      .pill-btn.primary:hover {
        background: #e0e7ff;
      }

      .review-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fff7ed;
        border: 1px solid #fdba74;
        color: #b45309;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
        transition: 0.2s;
      }

      .review-btn:hover {
        background: #ffedd5;
      }

      /* =============== MODE SWITCH BUTTONS =============== */
      .mode-switch {
        margin: 18px 0 18px;
        background: #f9fafb;
        border-radius: 999px;
        padding: 4px;
        display: inline-flex;
        gap: 4px;
        border: 1px solid #e5e7eb;
        flex-wrap: wrap;
      }

      .mode-btn {
        border-radius: 999px;
        border: none;
        padding: 8px 12px;
        background: transparent;
        font-size: 13px;
        cursor: pointer;
        color: #4b5563;
        transition: all 0.15s ease;
      }

      .mode-btn.active {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: #ffffff;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.35);
      }

      .mode-hint {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 18px;
      }

      /* =============== QUIZ LAYOUT =============== */
      #quiz-layout {
        display: grid;
        grid-template-columns: 1fr 1.3fr;
        gap: 20px;
      }

      @media (max-width: 900px) {
        #quiz-layout {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: #f9fafb;
        border-radius: 16px;
        padding: 18px;
        border: 1px solid #e5e7eb;
      }

      /* =============== QUIZ PANEL =============== */
      .kanji-display {
        font-size: 64px;
        text-align: center;
        font-weight: 700;
        margin-bottom: 6px;
      }

      .kanji-display.small-text {
        font-size: 32px;
      }

      .reading {
        text-align: center;
        color: #4b5563;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .question-text {
        text-align: center;
        font-size: 15px;
        color: #374151;
        margin-bottom: 12px;
      }

      .options {
        display: grid;
        gap: 10px;
      }

      .option-btn {
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.15s;
      }

      .option-btn:hover {
        border-color: #a5b4fc;
        background: #eef2ff;
      }

      .option-btn.correct {
        background: #dcfce7;
        border-color: #16a34a;
      }

      .option-btn.wrong {
        background: #fee2e2;
        border-color: #b91c1c;
      }

      .feedback {
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
      }

      .feedback.correct {
        color: #16a34a;
      }

      .feedback.wrong {
        color: #b91c1c;
      }

      .actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
      }

      .btn {
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        background: #ffffff;
      }

      .btn-primary {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        border: none;
        color: #fff;
      }

      .btn-outline {
        background: #fff;
        border: 1px solid #e5e7eb;
      }

      /* =============== INFO PANEL =============== */
      #info-panel h2 {
        margin: 0 0 8px;
        font-size: 18px;
      }

      .info-row {
        font-size: 14px;
        margin-bottom: 4px;
      }

      .info-label {
        font-weight: 600;
      }

      .compound-list {
        margin-left: 20px;
      }

      .example {
        margin-top: 10px;
        background: #e0f2fe;
        padding: 10px;
        border-radius: 10px;
      }

      .mode-pill {
        background: #e5e7eb;
        padding: 4px 10px;
        border-radius: 999px;
        display: inline-block;
        margin-bottom: 8px;
        font-size: 12px;
      }

      .tag-level {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4f46e5;
        font-size: 11px;
        margin-left: 6px;
      }

      /* =============== BOTTOM SHEET MODAL =============== */

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(2px);
        display: none;
        justify-content: flex-end; /* bottom sheet */
        align-items: flex-end;
        z-index: 9999;
      }

      /* Bottom sheet box */
      .modal-box {
        width: 100%;
        max-width: 640px;
        background: #ffffff;
        border-radius: 20px 20px 0 0;
        padding: 20px 22px;
        box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.2);
        animation: sheetSlideUp 0.28s ease;
        max-height: 85vh;
        overflow-y: auto;
      }

      /* Slide Up Animation */
      @keyframes sheetSlideUp {
        from {
          transform: translateY(100%);
          opacity: 0.3;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Drag handle */
      .sheet-handle {
        width: 42px;
        height: 5px;
        background: #d1d5db;
        border-radius: 999px;
        margin: 0 auto 14px;
      }

      /* Inputs */
      .modal-box input,
      .modal-box textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #d1d5db;
        background: #f8fafc;
        margin-bottom: 12px;
        font-size: 15px;
        transition: 0.2s;
      }

      .modal-box input:focus,
      .modal-box textarea:focus {
        outline: none;
        border-color: #6366f1;
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.22);
      }

      /* Compound row */
      .compound-row {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
      }

      .compound-row input {
        flex: 1;
      }

      /* Buttons */
      .modal-box button {
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        font-size: 15px;
        cursor: pointer;
        transition: 0.18s;
      }

      /* Primary btn */
      .btn-primary {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
        color: white;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.35);
      }

      /* Outline btn */
      .btn-outline {
        background: white;
        border: 1px solid #d1d5db;
      }

      .btn-outline:hover {
        background: #f3f4f6;
      }

      /* MOBILE */
      @media (max-width: 480px) {
        .modal-box {
          padding: 16px;
          border-radius: 18px 18px 0 0;
        }

        .compound-row {
          flex-direction: column;
        }
      }

      /* Manage Modal specific */

      .manage-box {
        width: clamp(300px, 95vw, 600px);
      }

      .user-kanji-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px dashed #e5e7eb;
        font-size: 13px;
      }

      .user-kanji-main {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-kanji-char {
        font-size: 20px;
        font-weight: 700;
        width: 32px;
        text-align: center;
      }

      .user-kanji-meaning {
        color: #4b5563;
      }

      .tiny-btn {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        cursor: pointer;
        border: 1px solid #f87171;
        background: #fef2f2;
        color: #b91c1c;
      }

      .tiny-btn.secondary {
        border-color: #9ca3af;
        background: #f9fafb;
        color: #374151;
      }

      .manage-toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .manage-toolbar input {
        max-width: 220px;
      }
      /* --- Swipe gesture smooth --- */
      .modal-box {
        touch-action: none; /* cho ph√©p b·∫Øt gesture */
        will-change: transform;
        transition: transform 0.25s ease;
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <h1>
        <span class="logo-dot"></span>
        N3 Kanji
      </h1>

      <div class="header-row-top">
        <div style="display: flex; gap: 8px; flex-wrap: wrap">
          <button id="add-kanji-btn" class="pill-btn primary">
            ‚ûï Th√™m Kanji m·ªõi
          </button>
          <button id="manage-kanji-btn" class="pill-btn">
            üìö Qu·∫£n l√Ω Kanji ƒë√£ th√™m
          </button>
        </div>

        <button id="review-btn" class="review-btn">
          ‚òÖ √în t·ª´ sai (<span id="wrong-count">0</span>)
        </button>
      </div>

      <p class="subtitle">
        √în Kanji &amp; T·ª´ gh√©p (compounds) N3 ‚Äì k√®m ch·∫ø ƒë·ªô ‚Äú√în t·ª´ sai‚Äù t·ª± ƒë·ªông
        l∆∞u khi b·∫°n tr·∫£ l·ªùi sai. Kanji b·∫°n t·ª± th√™m s·∫Ω ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát
        (localStorage) v√† t·ª± ƒë·ªông g·ªôp v√†o b·ªô quiz.
      </p>

      <!-- HEADER -->
      <div class="header-row">
        <div class="score-box">
          C√¢u:
          <span id="current-question">0</span> /
          <span id="total-question">0</span>
          ‚Ä¢ ƒê√∫ng:
          <span id="correct-count">0</span>
        </div>
      </div>

      <!-- MODE SWITCH -->
      <div class="mode-switch">
        <button class="mode-btn active" data-mode="kanji-meaning">
          Â≠ó Kanji ‚Üí Nghƒ©a
        </button>
        <button class="mode-btn" data-mode="compound-meaning">
          Ë™û T·ª´ gh√©p ‚Üí Nghƒ©a
        </button>
        <button class="mode-btn" data-mode="meaning-to-item">
          VI Nghƒ©a ‚Üí Kanji / Ë™û
        </button>
        <button class="mode-btn" data-mode="reading">„ÅÇ ƒê·ªçc (Kana)</button>
      </div>

      <div class="mode-hint" id="mode-hint">
        Ch·∫ø ƒë·ªô Kanji ‚Üí Nghƒ©a: Nh√¨n Kanji, ch·ªçn nghƒ©a ƒë√∫ng.
      </div>

      <!-- QUIZ LAYOUT -->
      <div id="quiz-layout">
        <!-- QUIZ PANEL -->
        <div class="card">
          <div id="quiz-display"></div>
          <div id="quiz-options" class="options"></div>
          <div id="quiz-feedback" class="feedback"></div>
          <div id="quiz-actions" class="actions"></div>
        </div>

        <!-- INFO PANEL -->
        <div id="info-panel" class="card">
          <h2>Th√¥ng tin</h2>
          <div id="info-content">
            H√£y ch·ªçn m·ªôt ƒë√°p √°n ƒë·ªÉ xem th√™m th√¥ng tin chi ti·∫øt v·ªÅ Kanji / t·ª´
            gh√©p.
          </div>
        </div>
      </div>
      <!-- end quiz-layout -->
    </div>

    <!-- ================= MODAL: TH√äM KANJI ================= -->
    <div id="kanji-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="sheet-handle"></div>
        <h3>‚ûï Th√™m Kanji m·ªõi</h3>
        <p style="font-size: 12px; color: #6b7280; margin-top: 0">
          ƒêi·ªÅn th√¥ng tin, sau ƒë√≥ b·∫•m
          <b>‚ÄúL∆∞u v√†o h·ªá th·ªëng‚Äù</b>
          ƒë·ªÉ Kanji t·ª± ƒë·ªông ƒë∆∞·ª£c th√™m v√†o b·ªô quiz. B·∫°n c≈©ng c√≥ th·ªÉ b·∫•m
          <b>‚ÄúT·∫°o Object‚Äù</b>
          ƒë·ªÉ copy object JSON d√πng ch·ªó kh√°c.
        </p>

        <label>Kanji:</label>
        <input id="k-kanji" />

        <label>Onyomi („Ç´„Çø„Ç´„Éä):</label>
        <input id="k-onyomi" />

        <label>Kunyomi („Å≤„Çâ„Åå„Å™):</label>
        <input id="k-kunyomi" />

        <label>Nghƒ©a (VI):</label>
        <input id="k-meaning" />

        <label>Level / Tag (VD: N3, N2, Bi·ªÉn b√°o...):</label>
        <input id="k-level" />

        <label>V√≠ d·ª• JP:</label>
        <input id="k-exampleJP" />

        <label>V√≠ d·ª• VI:</label>
        <input id="k-exampleVI" />

        <hr style="margin: 14px 0" />

        <h4 style="margin: 0 0 8px">Compounds (T·ª´ gh√©p)</h4>
        <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px">
          M·ªói d√≤ng m·ªôt t·ª´ gh√©p ‚Äì
          <span class="chip">T·ª´</span> / <span class="chip">Kana</span> /
          <span class="chip">Nghƒ©a (VI)</span>
        </div>
        <div id="compound-box"></div>
        <button id="add-compound" class="btn-outline" style="margin-top: 8px">
          Ôºã Th√™m d√≤ng t·ª´ gh√©p
        </button>

        <hr style="margin: 16px 0 10px" />

        <h4 style="margin: 0 0 4px">K·∫æT QU·∫¢ (copy v√†o n∆°i kh√°c n·∫øu mu·ªën)</h4>
        <textarea
          id="kanji-output"
          style="width: 100%; height: 150px; font-family: monospace"
        ></textarea>

        <div class="modal-footer">
          <div style="display: flex; gap: 6px; flex-wrap: wrap">
            <button id="gen-kanji" class="btn btn-primary">T·∫°o Object</button>
            <button id="save-kanji" class="btn btn-outline">
              üíæ L∆∞u v√†o h·ªá th·ªëng
            </button>
          </div>

          <div style="display: flex; gap: 6px; flex-wrap: wrap">
            <button id="copy-kanji" class="btn btn-outline">
              üìã Copy Object
            </button>
            <button id="close-kanji" class="btn btn-outline">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= MODAL: QU·∫¢N L√ù KANJI ƒê√É TH√äM ================= -->
    <div id="manage-modal" class="modal-overlay">
      <div class="modal-box manage-box">
        <h3>üìö Qu·∫£n l√Ω Kanji ƒë√£ th√™m</h3>

        <div class="manage-toolbar">
          <input id="manage-search" placeholder="T√¨m theo Kanji / nghƒ©a..." />
          <button id="export-json" class="btn btn-outline">‚¨á Xu·∫•t JSON</button>
          <button id="import-json" class="btn btn-outline">‚¨Ü Nh·∫≠p JSON</button>
          <button id="clear-user-kanji" class="btn btn-outline">
            üóë Xo√° to√†n b·ªô
          </button>
          <button id="close-manage" class="btn btn-outline">ƒê√≥ng</button>
        </div>

        <div
          id="manage-list"
          style="
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            max-height: 220px;
            overflow-y: auto;
            background: #f9fafb;
            margin-bottom: 10px;
          "
        ></div>

        <label style="margin-top: 4px"
          >Backup JSON (c√≥ th·ªÉ copy / ch·ªânh s·ª≠a r·ªìi Nh·∫≠p l·∫°i):</label
        >
        <textarea
          id="manage-json"
          style="width: 100%; height: 150px; font-family: monospace"
        ></textarea>
      </div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script>
      /* ============ DATA G·ªêC ============ */
      const vocabListDefault = [
        {
          id: 1,
          type: "kanji",
          kanji: "Èßê",
          kana: "„ÉÅ„É•„Ç¶",
          onyomi: "„ÉÅ„É•„Ç¶",
          kunyomi: "",
          meaning: "ƒë·ªó xe, c∆∞ tr√∫",
          exampleJP: "ÈßêËªäÂ†¥„Å´Ëªä„ÇíÊ≠¢„ÇÅ„Çã„ÄÇ",
          exampleVI: "ƒê·ªó xe trong b√£i ƒë·ªó xe.",
          compounds: [
            { word: "ÈßêËªä", kana: "„Å°„ÇÖ„ÅÜ„Åó„ÇÉ", vi: "ƒë·ªó xe" },
            { word: "ÈßêËªäÂ†¥", kana: "„Å°„ÇÖ„ÅÜ„Åó„ÇÉ„Åò„Çá„ÅÜ", vi: "b√£i ƒë·ªó xe" },
          ],
        },
        {
          id: 2,
          type: "kanji",
          kanji: "ÁÑ°",
          kana: "„É†Ôºè„Éñ",
          onyomi: "„É†„Éª„Éñ",
          kunyomi: "„Å™„ÅÑ",
          meaning: "kh√¥ng, v√¥",
          exampleJP: "ÁÑ°ÁêÜ„Çí„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
          exampleVI: "ƒê·ª´ng c·ªë qu√°.",
          compounds: [
            { word: "ÁÑ°‰ºë", kana: "„ÇÄ„Åç„ÇÖ„ÅÜ", vi: "kh√¥ng ngh·ªâ" },
            { word: "ÁÑ°ÁêÜÔºà„Å™Ôºâ", kana: "„ÇÄ„ÇäÔºà„Å™Ôºâ", vi: "v√¥ l√Ω, qu√° s·ª©c" },
            { word: "ÁÑ°Êñô", kana: "„ÇÄ„Çä„Çá„ÅÜ", vi: "mi·ªÖn ph√≠" },
            { word: "ÁÑ°„ÅÑ", kana: "„Å™„ÅÑ", vi: "kh√¥ng c√≥" },
          ],
        },
        {
          id: 3,
          type: "kanji",
          kanji: "Ê∫Ä",
          kana: "„Éû„É≥",
          onyomi: "„Éû„É≥",
          kunyomi: "„Åø-„Å°„Çã",
          meaning: "ƒë·∫ßy, m√£n",
          exampleJP: "ÈßêËªäÂ†¥„ÅØÊ∫ÄËªä„Åß„Åô„ÄÇ",
          exampleVI: "B√£i ƒë·ªó xe ƒë√£ ƒë·∫ßy.",
          compounds: [
            { word: "Ê∫ÄËªä", kana: "„Åæ„Çì„Åó„ÇÉ", vi: "ƒë·∫ßy xe" },
            { word: "‰∏çÊ∫ÄÔºà„Å™Ôºâ", kana: "„Åµ„Åæ„ÇìÔºà„Å™Ôºâ", vi: "b·∫•t m√£n" },
          ],
        },
        {
          id: 4,
          type: "kanji",
          kanji: "Âêë",
          kana: "„Ç≥„Ç¶",
          onyomi: "„Ç≥„Ç¶",
          kunyomi: "„ÇÄ-„ÅèÔºè„ÇÄ-„Åã„ÅÜ",
          meaning: "h∆∞·ªõng, h∆∞·ªõng v·ªÅ",
          exampleJP: "ÈßÖ„ÅÆÊñπÂêë„Å∏Âêë„Åã„ÅÜ„ÄÇ",
          exampleVI: "H∆∞·ªõng v·ªÅ ph√≠a nh√† ga.",
          compounds: [
            { word: "ÊñπÂêë", kana: "„Åª„ÅÜ„Åì„ÅÜ", vi: "ph∆∞∆°ng h∆∞·ªõng" },
            { word: "Âêë„Åã„ÅÜ", kana: "„ÇÄ„Åã„ÅÜ", vi: "h∆∞·ªõng t·ªõi" },
          ],
        },
        {
          id: 5,
          type: "kanji",
          kanji: "Á¶Å",
          kana: "„Ç≠„É≥",
          onyomi: "„Ç≠„É≥",
          kunyomi: "",
          meaning: "c·∫•m",
          exampleJP: "„Åì„Åì„ÅØÁ¶ÅÁÖô„Åß„Åô„ÄÇ",
          exampleVI: "·ªû ƒë√¢y c·∫•m h√∫t thu·ªëc.",
          compounds: [{ word: "Á¶ÅÊ≠¢", kana: "„Åç„Çì„Åó", vi: "c·∫•m ƒëo√°n" }],
        },
        {
          id: 6,
          type: "kanji",
          kanji: "Èñ¢",
          kana: "„Ç´„É≥",
          onyomi: "„Ç´„É≥",
          kunyomi: "„Åã„Åã-„Çè„Çã„Éª„Åõ„Åç",
          meaning: "li√™n quan, quan h·ªá",
          exampleJP: "„Åì„ÅÆÂïèÈ°å„Å´Èñ¢ÂøÉ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
          exampleVI: "T√¥i c√≥ quan t√¢m ƒë·∫øn v·∫•n ƒë·ªÅ n√†y.",
          compounds: [{ word: "Èñ¢ÂøÉ", kana: "„Åã„Çì„Åó„Çì", vi: "quan t√¢m" }],
        },
        {
          id: 7,
          type: "kanji",
          kanji: "‰øÇ",
          kana: "„Ç±„Ç§",
          onyomi: "„Ç±„Ç§",
          kunyomi: "„Åã„Åã-„Çä",
          meaning: "ng∆∞·ªùi ph·ª• tr√°ch",
          exampleJP: "‰øÇ„ÅÆ‰∫∫„Å´ËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
          exampleVI: "H√£y h·ªèi ng∆∞·ªùi ph·ª• tr√°ch.",
          compounds: [
            { word: "Èñ¢‰øÇ", kana: "„Åã„Çì„Åë„ÅÑ", vi: "m·ªëi quan h·ªá, li√™n quan" },
            { word: "‰øÇ", kana: "„Åã„Åã„Çä", vi: "ng∆∞·ªùi ph·ª• tr√°ch" },
          ],
        },
        {
          id: 8,
          type: "kanji",
          kanji: "Êñ≠",
          kana: "„ÉÄ„É≥",
          onyomi: "„ÉÄ„É≥",
          kunyomi: "„Åì„Å®„Çè-„Çã",
          meaning: "t·ª´ ch·ªëi, c·∫Øt ƒë·ª©t",
          exampleJP: "ÂΩº„ÅÆ„ÅäÈ°ò„ÅÑ„ÇíÊñ≠„Å£„Åü„ÄÇ",
          exampleVI: "T√¥i ƒë√£ t·ª´ ch·ªëi l·ªùi nh·ªù v·∫£ c·ªßa anh ·∫•y.",
          compounds: [
            { word: "ÁÑ°Êñ≠", kana: "„ÇÄ„Å†„Çì", vi: "kh√¥ng xin ph√©p" },
            { word: "Êñ≠„Çã", kana: "„Åì„Å®„Çè„Çã", vi: "t·ª´ ch·ªëi" },
          ],
        },
        {
          id: 9,
          type: "kanji",
          kanji: "Ê®™",
          kana: "„É®„Ç≥",
          onyomi: "„Ç™„Ç¶",
          kunyomi: "„Çà„Åì",
          meaning: "ngang, b√™n c·∫°nh",
          exampleJP: "Ê®™Êñ≠Ê≠©ÈÅì„ÇíÊ∏°„Çã„ÄÇ",
          exampleVI: "BƒÉng qua l·ªëi bƒÉng qua ƒë∆∞·ªùng.",
          compounds: [
            { word: "Ê®™Êñ≠", kana: "„Åä„ÅÜ„Å†„Çì", vi: "bƒÉng ngang (ƒë∆∞·ªùng)" },
            { word: "Ê®™", kana: "„Çà„Åì", vi: "b√™n c·∫°nh, ngang, b√™n h√¥ng" },
          ],
        },
        {
          id: 10,
          type: "kanji",
          kanji: "Êäº",
          kana: "„Åä-„Åô",
          onyomi: "„Ç™„Ç¶",
          kunyomi: "„Åä-„ÅôÔºè„Åä-„Åï„Åà„Çã",
          meaning: "·∫•n, ƒë·∫©y",
          exampleJP: "„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
          exampleVI: "H√£y nh·∫•n n√∫t.",
          compounds: [
            { word: "Êäº„Åô", kana: "„Åä„Åô", vi: "·∫•n, nh·∫•n" },
            {
              word: "Êäº„ÅóÂÖ•„Çå",
              kana: "„Åä„Åó„ÅÑ„Çå",
              vi: "t·ªß t∆∞·ªùng, t·ªß √¢m t∆∞·ªùng",
            },
            {
              word: "Êäº„Åó„Éú„Çø„É≥Âºè",
              kana: "„Åä„Åó„Éú„Çø„É≥„Åó„Åç",
              vi: "ki·ªÉu c√≥ n√∫t nh·∫•n",
            },
            { word: "Êäº„Åï„Åà„Çã", kana: "„Åä„Åï„Åà„Çã", vi: "gi·ªØ l·∫°i, ƒë√® gi·ªØ" },
          ],
        },
        {
          id: 11,
          type: "kanji",
          kanji: "Âºè",
          kana: "„Ç∑„Ç≠",
          onyomi: "„Ç∑„Ç≠",
          kunyomi: "",
          meaning: "nghi th·ª©c, ki·ªÉu, c√¥ng th·ª©c",
          exampleJP: "ÂÖ•Â≠¶Âºè„Å´Âá∫Â∏≠„Åô„Çã„ÄÇ",
          exampleVI: "Tham d·ª± l·ªÖ nh·∫≠p h·ªçc.",
          compounds: [
            { word: "Êï∞Âºè", kana: "„Åô„ÅÜ„Åó„Åç", vi: "c√¥ng th·ª©c s·ªë" },
            { word: "ÂÖ•Â≠¶Âºè", kana: "„Å´„ÇÖ„ÅÜ„Åå„Åè„Åó„Åç", vi: "l·ªÖ nh·∫≠p h·ªçc" },
          ],
        },
        {
          id: 12,
          type: "kanji",
          kanji: "‰ø°",
          kana: "„Ç∑„É≥",
          onyomi: "„Ç∑„É≥",
          kunyomi: "",
          meaning: "tin t∆∞·ªüng, t√≠n hi·ªáu",
          exampleJP: "Ëá™ÂàÜ„Çí‰ø°„Åò„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
          exampleVI: "H√£y tin v√†o b·∫£n th√¢n.",
          compounds: [
            { word: "ÈÄÅ‰ø°", kana: "„Åù„ÅÜ„Åó„Çì", vi: "g·ª≠i (t√≠n hi·ªáu, mail)" },
            { word: "Ëá™‰ø°", kana: "„Åò„Åó„Çì", vi: "t·ª± tin" },
            { word: "‰ø°Âè∑", kana: "„Åó„Çì„Åî„ÅÜ", vi: "ƒë√®n t√≠n hi·ªáu" },
            { word: "‰ø°„Åò„Çã", kana: "„Åó„Çì„Åò„Çã", vi: "tin t∆∞·ªüng" },
            { word: "‰ø°Áî®", kana: "„Åó„Çì„Çà„ÅÜ", vi: "t√≠n nhi·ªám" },
          ],
        },
        {
          id: 13,
          type: "kanji",
          kanji: "Âè∑",
          kana: "„Ç¥„Ç¶",
          onyomi: "„Ç¥„Ç¶",
          kunyomi: "",
          meaning: "s·ªë hi·ªáu, k√Ω hi·ªáu",
          exampleJP: "„Åì„ÅÆÂàóËªä„ÅØÔºìÂè∑Ëªä„Åæ„Åß„ÅÇ„Çä„Åæ„Åô„ÄÇ",
          exampleVI: "T√†u n√†y c√≥ t·ªõi toa s·ªë 3.",
          compounds: [
            { word: "„ÄúÂè∑Ëªä", kana: "„Äú„Åî„ÅÜ„Åó„ÇÉ", vi: "toa s·ªë ~ (t√†u)" },
          ],
        },
        {
          id: 14,
          type: "kanji",
          kanji: "Á¢∫",
          kana: "„Ç´„ÇØ",
          onyomi: "„Ç´„ÇØ",
          kunyomi: "„Åü„Åó-„ÅãÔºè„Åü„Åó-„Åã„ÇÅ„Çã",
          meaning: "ch·∫Øc ch·∫Øn, x√°c nh·∫≠n",
          exampleJP: "‰∫àÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
          exampleVI: "H√£y x√°c nh·∫≠n l·∫°i l·ªãch.",
          compounds: [
            { word: "Ê≠£Á¢∫Ôºà„Å™Ôºâ", kana: "„Åõ„ÅÑ„Åã„ÅèÔºà„Å™Ôºâ", vi: "ch√≠nh x√°c" },
            { word: "Á¢∫„ÅãÔºà„Å™Ôºâ", kana: "„Åü„Åó„ÅãÔºà„Å™Ôºâ", vi: "ch·∫Øc ch·∫Øn" },
            { word: "Á¢∫Ë™ç", kana: "„Åã„Åè„Å´„Çì", vi: "x√°c nh·∫≠n" },
            { word: "Á¢∫„Åã„ÇÅ„Çã", kana: "„Åü„Åó„Åã„ÇÅ„Çã", vi: "ki·ªÉm ch·ª©ng" },
          ],
        },
        {
          id: 15,
          type: "kanji",
          kanji: "Ë™ç",
          kana: "„Éã„É≥",
          onyomi: "„Éã„É≥",
          kunyomi: "„Åø„Å®-„ÇÅ„Çã",
          meaning: "c√¥ng nh·∫≠n, ch·∫•p nh·∫≠n",
          exampleJP: "ÂΩº„ÅÆÂä™Âäõ„ÇíË™ç„ÇÅ„Çã„ÄÇ",
          exampleVI: "C√¥ng nh·∫≠n n·ªó l·ª±c c·ªßa anh ·∫•y.",
          compounds: [
            { word: "Ë™ç„ÇÅ„Çã", kana: "„Åø„Å®„ÇÅ„Çã", vi: "th·ª´a nh·∫≠n, ch·∫•p nh·∫≠n" },
          ],
        },
        {
          id: 16,
          type: "kanji",
          kanji: "È£õ",
          kana: "„Éí",
          onyomi: "„Éí",
          kunyomi: "„Å®-„Å∂",
          meaning: "bay",
          exampleJP: "È≥•„ÅåÁ©∫„ÇíÈ£õ„Çì„Åß„ÅÑ„Çã„ÄÇ",
          exampleVI: "Chim ƒëang bay tr√™n tr·ªùi.",
          compounds: [
            { word: "È£õË°åÂ†¥", kana: "„Å≤„Åì„ÅÜ„Åò„Çá„ÅÜ", vi: "s√¢n bay" },
            { word: "È£õ„Å∂", kana: "„Å®„Å∂", vi: "bay" },
          ],
        },
      ];

      /* ============ USER STORAGE ============ */
      const VOCAB_USER_KEY = "N3_USER_KANJI_OMEGA";
      const WRONG_KEY = "N3_WRONG_LIST";

      function loadUserKanji() {
        try {
          return JSON.parse(localStorage.getItem(VOCAB_USER_KEY)) || [];
        } catch {
          return [];
        }
      }

      function saveUserKanji(list) {
        localStorage.setItem(VOCAB_USER_KEY, JSON.stringify(list));
      }

      function loadWrongList() {
        try {
          return JSON.parse(localStorage.getItem(WRONG_KEY)) || [];
        } catch {
          return [];
        }
      }

      function saveWrongList(list) {
        localStorage.setItem(WRONG_KEY, JSON.stringify(list));
      }

      /* ============ GLOBAL STATE DATA ARRAYS ============ */
      let userKanji = [];
      let vocabList = [];
      let compoundItems = [];
      let kanjiItems = [];
      let combinedItems = [];

      function rebuildData() {
        vocabList = [...vocabListDefault, ...userKanji];

        compoundItems = [];
        vocabList.forEach((k) => {
          (k.compounds || []).forEach((c, index) => {
            compoundItems.push({
              type: "compound",
              id: `c-${k.id}-${index}`,
              word: c.word,
              kana: c.kana,
              meaning: c.vi,
              parentKanji: k.kanji,
              parentMeaning: k.meaning,
            });
          });
        });

        kanjiItems = vocabList.filter((it) => it.type === "kanji");
        combinedItems = [...kanjiItems, ...compoundItems];
      }

      /* ============ HELPERS ============ */

      function shuffle(arr) {
        return arr
          .map((x) => ({ x, r: Math.random() }))
          .sort((a, b) => a.r - b.r)
          .map((obj) => obj.x);
      }

      function pickRandomOptions(correct, list, count) {
        const filtered = list.filter((i) => i !== correct);
        return shuffle(filtered).slice(0, count);
      }

      function isKanji(item) {
        return item.type === "kanji";
      }

      function updateWrongCount() {
        const el = document.getElementById("wrong-count");
        if (!el) return;
        el.textContent = loadWrongList().length;
      }

      function addWrongItem(item, mode) {
        const wrongList = loadWrongList();
        const itemKey = `${item.type}_${item.id}_${mode}`;
        const exists = wrongList.some((x) => x.key === itemKey);
        if (!exists) {
          wrongList.push({
            key: itemKey,
            id: item.id,
            type: item.type,
            mode: mode,
          });
          saveWrongList(wrongList);
        }
        updateWrongCount();
      }

      function clearWrongList() {
        localStorage.removeItem(WRONG_KEY);
        updateWrongCount();
      }
      /* ============ REVIEW MODE QUESTION GENERATOR ============ */

      function pickRandomMode() {
        const modes = [
          "kanji-meaning",
          "compound-meaning",
          "meaning-to-item",
          "reading",
        ];
        return modes[Math.floor(Math.random() * modes.length)];
      }

      function generateReviewQuestions() {
        const wrongList = loadWrongList();
        if (wrongList.length === 0) return [];

        const wrongCount = Math.ceil(wrongList.length * 0.7);
        const selectedWrong = shuffle(wrongList).slice(0, wrongCount);

        const wrongItemsMapped = selectedWrong
          .map((w) => {
            let source;
            if (w.type === "kanji") {
              source = kanjiItems.find((k) => String(k.id) === String(w.id));
            } else {
              source = compoundItems.find((c) => String(c.id) === String(w.id));
            }
            if (!source) return null;
            return { ...w, item: source };
          })
          .filter((x) => x && x.item);

        const randomCount = Math.floor(wrongList.length * 0.3);
        const randomPool = shuffle(combinedItems).slice(0, randomCount);
        const randomMapped = randomPool.map((item) => ({
          key: "random_" + Math.random(),
          id: item.id,
          type: item.type,
          mode: pickRandomMode(),
          item: item,
        }));

        return shuffle([...wrongItemsMapped, ...randomMapped]);
      }
      /* ============ QUIZ STATE ============ */

      const MODE_KANJI_MEANING = "kanji-meaning";
      const MODE_COMPOUND_MEANING = "compound-meaning";
      const MODE_MEANING_TO_ITEM = "meaning-to-item";
      const MODE_READING = "reading";
      const MODE_REVIEW_WRONG = "review-wrong";

      const modeDescriptions = {
        [MODE_KANJI_MEANING]:
          "Ch·∫ø ƒë·ªô Kanji ‚Üí Nghƒ©a: Nh√¨n Kanji, ch·ªçn nghƒ©a ƒë√∫ng.",
        [MODE_COMPOUND_MEANING]: "Ch·∫ø ƒë·ªô T·ª´ gh√©p ‚Üí Nghƒ©a.",
        [MODE_MEANING_TO_ITEM]:
          "Ch·∫ø ƒë·ªô Nghƒ©a ‚Üí ch·ªçn Kanji ho·∫∑c T·ª´ gh√©p ph√π h·ª£p.",
        [MODE_READING]: "Ch·∫ø ƒë·ªô ch·ªçn c√°ch ƒë·ªçc (Kana).",
        [MODE_REVIEW_WRONG]:
          "‚≠ê ƒêang ·ªü ch·∫ø ƒë·ªô √îN T·ª™ SAI ‚Äì h·ªèi l·∫°i nh·ªØng m·ª•c b·∫°n tr·∫£ l·ªùi sai.",
      };

      let currentMode = MODE_KANJI_MEANING;
      let questionList = [];
      let currentIndex = 0;
      let correctCount = 0;
      let inReviewMode = false;
      let reviewQuestions = [];
      let currentReviewIndex = 0;

      function startQuiz(mode) {
        inReviewMode = false;
        currentMode = mode;
        currentIndex = 0;
        correctCount = 0;

        switch (mode) {
          case MODE_KANJI_MEANING:
            questionList = shuffle(kanjiItems);
            break;
          case MODE_COMPOUND_MEANING:
            questionList = shuffle(compoundItems);
            break;
          case MODE_MEANING_TO_ITEM:
          case MODE_READING:
            questionList = shuffle(combinedItems);
            break;
        }

        updateHeader();
        renderQuestion();
      }

      function updateHeader() {
        const cq = document.getElementById("current-question");
        const tq = document.getElementById("total-question");
        const cc = document.getElementById("correct-count");
        const mh = document.getElementById("mode-hint");
        if (!cq) return;
        cq.textContent = currentIndex + 1;
        tq.textContent = questionList.length;
        cc.textContent = correctCount;
        mh.textContent = modeDescriptions[currentMode];
      }

      function buildQuestion(item, mode) {
        let question = {
          item,
          mode,
          questionText: "",
          displayMain: "",
          reading: "",
          options: [],
          correctAnswer: "",
        };

        if (mode === MODE_KANJI_MEANING) {
          question.displayMain = item.kanji;
          question.questionText = "Ch·ªçn nghƒ©a ƒë√∫ng c·ªßa ch·ªØ Kanji d∆∞·ªõi ƒë√¢y:";
          question.correctAnswer = item.meaning;

          let wrongs = pickRandomOptions(item, kanjiItems, 3).map(
            (i) => i.meaning
          );
          question.options = shuffle([item.meaning, ...wrongs]);
        } else if (mode === MODE_COMPOUND_MEANING) {
          question.displayMain = item.word;
          question.questionText = "Ch·ªçn nghƒ©a ƒë√∫ng c·ªßa t·ª´ gh√©p:";
          question.correctAnswer = item.meaning;

          let wrongs = pickRandomOptions(item, compoundItems, 3).map(
            (i) => i.meaning
          );
          question.options = shuffle([item.meaning, ...wrongs]);
        } else if (mode === MODE_MEANING_TO_ITEM) {
          question.displayMain = item.meaning;
          question.questionText = "Ch·ªçn Kanji / t·ª´ gh√©p t∆∞∆°ng ·ª©ng:";
          question.correctAnswer = isKanji(item) ? item.kanji : item.word;

          let wrongs = pickRandomOptions(item, combinedItems, 3).map((i) =>
            isKanji(i) ? i.kanji : i.word
          );
          question.options = shuffle([question.correctAnswer, ...wrongs]);
        } else if (mode === MODE_READING) {
          question.displayMain = isKanji(item) ? item.kanji : item.word;
          question.questionText = "Ch·ªçn c√°ch ƒë·ªçc ƒë√∫ng (Kana):";
          question.correctAnswer = item.kana;

          let wrongs = pickRandomOptions(item, combinedItems, 3).map(
            (i) => i.kana
          );
          question.options = shuffle([item.kana, ...wrongs]);
        }

        return question;
      }

      function renderQuestion() {
        if (inReviewMode) {
          if (currentReviewIndex >= reviewQuestions.length) {
            showReviewEnd();
            return;
          }
          const qObj = reviewQuestions[currentReviewIndex];
          const q = buildQuestion(qObj.item, qObj.mode);
          renderQuestionUI(q);
          return;
        }

        if (currentIndex >= questionList.length) {
          showQuizEnd();
          return;
        }

        const q = buildQuestion(questionList[currentIndex], currentMode);
        renderQuestionUI(q);
      }

      function renderQuestionUI(q) {
        const display = document.getElementById("quiz-display");
        const options = document.getElementById("quiz-options");
        const feedback = document.getElementById("quiz-feedback");

        display.innerHTML = `
          <div class="kanji-display ${
            q.displayMain.length >= 5 ? "small-text" : ""
          }">${q.displayMain}</div>
          <div class="reading">${q.reading || ""}</div>
          <div class="question-text">${q.questionText}</div>
        `;

        options.innerHTML = "";
        q.options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = opt;
          btn.onclick = () => {
            checkAnswer(q, opt, btn);
          };
          options.appendChild(btn);
        });

        feedback.textContent = "";
        feedback.className = "feedback";
      }

      function checkAnswer(q, selected, btn) {
        const feedback = document.getElementById("quiz-feedback");
        const options = document.querySelectorAll(".option-btn");

        options.forEach((b) => (b.disabled = true));

        if (selected === q.correctAnswer) {
          btn.classList.add("correct");
          feedback.textContent = "‚úî Ch√≠nh x√°c!";
          feedback.className = "feedback correct";

          if (!inReviewMode) correctCount++;
        } else {
          btn.classList.add("wrong");
          feedback.textContent = "‚úò Sai r·ªìi!";
          feedback.className = "feedback wrong";

          if (!inReviewMode) addWrongItem(q.item, q.mode);
        }

        updateHeader();

        const actions = document.getElementById("quiz-actions");
        actions.innerHTML = `
          <button class="btn btn-primary" id="next-btn">C√¢u ti·∫øp theo ‚Üí</button>
        `;
        document.getElementById("next-btn").onclick = () => nextQuestion();
        updateInfoPanel(q.item);
      }

      function nextQuestion() {
        const actions = document.getElementById("quiz-actions");
        actions.innerHTML = "";

        if (inReviewMode) {
          currentReviewIndex++;
        } else {
          currentIndex++;
        }

        renderQuestion();
      }

      function showQuizEnd() {
        const display = document.getElementById("quiz-display");
        const options = document.getElementById("quiz-options");
        const actions = document.getElementById("quiz-actions");

        display.innerHTML = `
          <h2>üéâ B·∫°n ƒë√£ ho√†n th√†nh quiz!</h2>
          <p>ƒêi·ªÉm: ${correctCount} / ${questionList.length}</p>
        `;
        options.innerHTML = "";
        actions.innerHTML = `
          <button class="btn btn-primary" onclick="startQuiz('${currentMode}')">
            L√†m l·∫°i
          </button>
        `;
      }

      function startReviewMode() {
        const wrongList = loadWrongList();
        if (wrongList.length === 0) {
          alert("Kh√¥ng c√≥ t·ª´ sai n√†o ƒë·ªÉ √¥n l·∫°i!");
          return;
        }

        inReviewMode = true;
        currentMode = MODE_REVIEW_WRONG;

        reviewQuestions = generateReviewQuestions();
        currentReviewIndex = 0;

        document.getElementById("mode-hint").textContent =
          modeDescriptions[MODE_REVIEW_WRONG];

        renderReviewHeader();
        renderQuestion();
      }

      function renderReviewHeader() {
        document.getElementById("current-question").textContent =
          currentReviewIndex + 1;
        document.getElementById("total-question").textContent =
          reviewQuestions.length;
        document.getElementById("correct-count").textContent = "-";
      }

      function showReviewEnd() {
        const display = document.getElementById("quiz-display");
        const options = document.getElementById("quiz-options");
        const actions = document.getElementById("quiz-actions");

        display.innerHTML = `
          <h2>‚≠ê Ho√†n th√†nh ch·∫ø ƒë·ªô √îN T·ª™ SAI!</h2>
          <p>B·∫°n ƒë√£ xem l·∫°i ${reviewQuestions.length} m·ª•c.</p>
        `;
        options.innerHTML = "";
        actions.innerHTML = `
          <button class="btn btn-primary" onclick="startReviewMode()">
            L√†m l·∫°i Review
          </button>
          <button class="btn btn-outline" onclick="clearWrongList()">
            Xo√° to√†n b·ªô t·ª´ sai
          </button>
          <button class="btn btn-outline" onclick="exitReview()">
            Tho√°t Review
          </button>
        `;
      }

      function exitReview() {
        inReviewMode = false;
        startQuiz(MODE_KANJI_MEANING);
      }

      /* ============ INFO PANEL ============ */

      function updateInfoPanel(item) {
        const info = document.getElementById("info-content");
        if (!info || !item) return;

        if (item.type === "kanji") {
          info.innerHTML = `
            <div class="mode-pill">KANJI ${
              item.level ? `<span class="tag-level">${item.level}</span>` : ""
            }</div>
            <div class="info-row"><span class="info-label">Ch·ªØ:</span> ${
              item.kanji
            }</div>
            <div class="info-row"><span class="info-label">√Çm On:</span> ${
              item.onyomi || ""
            }</div>
            <div class="info-row"><span class="info-label">√Çm Kun:</span> ${
              item.kunyomi || ""
            }</div>
            <div class="info-row"><span class="info-label">Nghƒ©a:</span> ${
              item.meaning
            }</div>

            <div class="example">
              <b>V√≠ d·ª•:</b><br>
              JP: ${item.exampleJP || "-"}<br>
              VI: ${item.exampleVI || "-"}
            </div>

            <div style="margin-top:10px;">
              <b>T·ª´ gh√©p:</b>
              <ul class="compound-list">
                ${(item.compounds || [])
                  .map((c) => `<li>${c.word} (${c.kana}) ‚Äì ${c.vi}</li>`)
                  .join("")}
              </ul>
            </div>
          `;
        } else if (item.type === "compound") {
          info.innerHTML = `
            <div class="mode-pill">T·ª™ GH√âP</div>
            <div class="info-row"><span class="info-label">T·ª´:</span> ${item.word}</div>
            <div class="info-row"><span class="info-label">C√°ch ƒë·ªçc:</span> ${item.kana}</div>
            <div class="info-row"><span class="info-label">Nghƒ©a:</span> ${item.meaning}</div>

            <div style="margin-top:10px;">
              <b>Thu·ªôc kanji:</b> ${item.parentKanji} ‚Äì ${item.parentMeaning}
            </div>
          `;
        }
      }

      /* ============ MODAL HELPERS ============ */

      function openModal(el) {
        el.style.display = "flex";
        const box = el.querySelector(".modal-box");
        if (!box) return;
        box.style.transform = "translateY(100%)";
        requestAnimationFrame(() => {
          box.style.transition = "transform 0.25s ease";
          box.style.transform = "translateY(0)";
        });
      }

      function closeModal(el) {
        const box = el.querySelector(".modal-box");
        if (!box) {
          el.style.display = "none";
          return;
        }
        box.style.transform = "translateY(120%)";
        setTimeout(() => {
          el.style.display = "none";
          box.style.transform = "translateY(0)";
        }, 220);
      }

      /* ==================== SWIPE TO DISMISS (MULTI MODAL SAFE) ==================== */
      document.querySelectorAll(".modal-overlay").forEach((overlay) => {
        const sheet = overlay.querySelector(".modal-box");
        if (!sheet) return;

        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        const CLOSE_THRESHOLD = 120;

        sheet.addEventListener("touchstart", (e) => {
          startY = e.touches[0].clientY;
          currentY = startY;
          isDragging = true;
          sheet.style.transition = "none";
        });

        sheet.addEventListener("touchmove", (e) => {
          if (!isDragging) return;

          currentY = e.touches[0].clientY;
          const diff = currentY - startY;

          if (diff > 0) {
            sheet.style.transform = `translateY(${diff}px)`;
          }
        });

        sheet.addEventListener("touchend", () => {
          isDragging = false;
          sheet.style.transition = "transform 0.25s ease";

          const diff = currentY - startY;

          if (diff > CLOSE_THRESHOLD) {
            sheet.style.transform = "translateY(120%)";
            setTimeout(() => {
              overlay.style.display = "none";
              sheet.style.transform = "translateY(0)";
            }, 220);
          } else {
            sheet.style.transform = "translateY(0)";
          }
        });
      });

      document.querySelectorAll(".modal-overlay").forEach((overlay) => {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            const sheet = overlay.querySelector(".modal-box");
            sheet.style.transform = "translateY(120%)";
            setTimeout(() => {
              overlay.style.display = "none";
              sheet.style.transform = "translateY(0)";
            }, 200);
          }
        });
      });

      /* ============ BUILD KANJI OBJECT FROM FORM ============ */

      function buildKanjiFromForm() {
        const kanji = document.getElementById("k-kanji").value.trim();
        const onyomi = document.getElementById("k-onyomi").value.trim();
        const kunyomi = document.getElementById("k-kunyomi").value.trim();
        const meaning = document.getElementById("k-meaning").value.trim();
        const exampleJP = document.getElementById("k-exampleJP").value.trim();
        const exampleVI = document.getElementById("k-exampleVI").value.trim();
        const level = document.getElementById("k-level").value.trim();

        const compounds = [
          ...document.querySelectorAll("#compound-box .compound-row"),
        ]
          .map((row) => {
            return {
              word: row.querySelector(".c-word").value.trim(),
              kana: row.querySelector(".c-kana").value.trim(),
              vi: row.querySelector(".c-vi").value.trim(),
            };
          })
          .filter((c) => c.word !== "");

        if (!kanji || !meaning) {
          alert("C·∫ßn √≠t nh·∫•t Kanji v√† Nghƒ©a VI.");
          return null;
        }

        const obj = {
          id: "u-" + Date.now() + "-" + Math.floor(Math.random() * 10000),
          type: "kanji",
          kanji,
          kana: onyomi || kunyomi || "",
          onyomi,
          kunyomi,
          meaning,
          exampleJP,
          exampleVI,
          level,
          compounds,
        };

        return obj;
      }

      function renderCompoundRow() {
        const box = document.getElementById("compound-box");
        const row = document.createElement("div");
        row.className = "compound-row";
        row.style.marginBottom = "6px";
        row.innerHTML = `
          <input placeholder="T·ª´" class="c-word" style="width:30%; padding:5px; margin-right:4px;">
          <input placeholder="Kana" class="c-kana" style="width:30%; padding:5px; margin-right:4px;">
          <input placeholder="Nghƒ©a (VI)" class="c-vi" style="width:35%; padding:5px;">
        `;
        box.appendChild(row);
      }

      function resetKanjiForm() {
        document.getElementById("k-kanji").value = "";
        document.getElementById("k-onyomi").value = "";
        document.getElementById("k-kunyomi").value = "";
        document.getElementById("k-meaning").value = "";
        document.getElementById("k-level").value = "N3";
        document.getElementById("k-exampleJP").value = "";
        document.getElementById("k-exampleVI").value = "";
        document.getElementById("kanji-output").value = "";

        const box = document.getElementById("compound-box");
        box.innerHTML = "";
        renderCompoundRow();
      }

      function addKanjiToUserList(obj) {
        userKanji.push(obj);
        saveUserKanji(userKanji);
        rebuildData();
        updateUserKanjiListUI();
        alert(
          "‚úî ƒê√£ l∆∞u Kanji m·ªõi v√†o h·ªá th·ªëng! Quiz s·∫Ω d√πng t·ª´ n√†y t·ª´ l·∫ßn ch∆°i ti·∫øp theo."
        );
      }

      /* ============ MANAGE USER KANJI UI ============ */

      function updateUserKanjiListUI(filterText = "") {
        const listEl = document.getElementById("manage-list");
        if (!listEl) return;
        const ft = filterText.trim().toLowerCase();

        if (userKanji.length === 0) {
          listEl.innerHTML =
            '<div style="font-size:13px; color:#6b7280;">Hi·ªán ch∆∞a c√≥ Kanji n√†o do b·∫°n th√™m. H√£y b·∫•m ‚ÄúTh√™m Kanji m·ªõi‚Äù.</div>';
          return;
        }

        const filtered = userKanji.filter((k) => {
          const combined =
            (k.kanji || "") + " " + (k.meaning || "") + " " + (k.level || "");
          return combined.toLowerCase().includes(ft);
        });

        if (filtered.length === 0) {
          listEl.innerHTML =
            '<div style="font-size:13px; color:#6b7280;">Kh√¥ng t√¨m th·∫•y Kanji ph√π h·ª£p v·ªõi t·ª´ kho√°.</div>';
          return;
        }

        listEl.innerHTML = filtered
          .map(
            (k) => `
          <div class="user-kanji-row">
            <div class="user-kanji-main">
              <div class="user-kanji-char">${k.kanji}</div>
              <div>
                <div>
                  <b>${k.meaning || ""}</b>
                  ${k.level ? `<span class="tag-level">${k.level}</span>` : ""}
                </div>
                <div style="font-size:11px; color:#6b7280;">
                  Onyomi: ${k.onyomi || "-"} ‚Ä¢ Kunyomi: ${k.kunyomi || "-"}
                </div>
              </div>
            </div>
            <button class="tiny-btn" data-del-id="${k.id}">Xo√°</button>
          </div>
        `
          )
          .join("");

        listEl.querySelectorAll("[data-del-id]").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-del-id");
            if (!confirm("Xo√° Kanji n√†y kh·ªèi h·ªá th·ªëng?")) return;
            userKanji = userKanji.filter((k) => k.id !== id);
            saveUserKanji(userKanji);
            rebuildData();
            updateUserKanjiListUI(ft);
          };
        });
      }

      /* ============ INIT ON LOAD ============ */
      window.addEventListener("load", () => {
        userKanji = loadUserKanji();
        rebuildData();
        updateWrongCount();

        // Mode switching
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const mode = btn.dataset.mode;
            document
              .querySelectorAll(".mode-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            startQuiz(mode);
          });
        });

        document.getElementById("review-btn").onclick = () => {
          startReviewMode();
        };

        // Add Kanji modal
        const addKanjiBtn = document.getElementById("add-kanji-btn");
        const kanjiModal = document.getElementById("kanji-modal");
        const closeKanji = document.getElementById("close-kanji");
        const addCompoundBtn = document.getElementById("add-compound");
        const genKanjiBtn = document.getElementById("gen-kanji");
        const saveKanjiBtn = document.getElementById("save-kanji");
        const copyKanjiBtn = document.getElementById("copy-kanji");
        const outputArea = document.getElementById("kanji-output");

        addKanjiBtn.onclick = () => {
          resetKanjiForm();
          openModal(kanjiModal);
        };

        closeKanji.onclick = () => {
          closeModal(kanjiModal);
        };

        addCompoundBtn.onclick = () => {
          renderCompoundRow();
        };

        genKanjiBtn.onclick = () => {
          const obj = buildKanjiFromForm();
          if (!obj) return;
          outputArea.value = JSON.stringify(obj, null, 2);
        };

        saveKanjiBtn.onclick = () => {
          const obj = buildKanjiFromForm();
          if (!obj) return;
          addKanjiToUserList(obj);
          outputArea.value = JSON.stringify(obj, null, 2);
        };

        copyKanjiBtn.onclick = () => {
          if (!outputArea.value.trim()) {
            const obj = buildKanjiFromForm();
            if (!obj) return;
            outputArea.value = JSON.stringify(obj, null, 2);
          }
          outputArea.select();
          try {
            document.execCommand("copy");
            alert("ƒê√£ copy object v√†o clipboard!");
          } catch {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ copy t·ª± ƒë·ªông, h√£y Ctrl+C.");
          }
        };

        // Manage modal
        const manageBtn = document.getElementById("manage-kanji-btn");
        const manageModal = document.getElementById("manage-modal");
        const closeManage = document.getElementById("close-manage");
        const manageSearch = document.getElementById("manage-search");
        const exportJsonBtn = document.getElementById("export-json");
        const importJsonBtn = document.getElementById("import-json");
        const clearUserBtn = document.getElementById("clear-user-kanji");
        const manageJsonArea = document.getElementById("manage-json");

        manageBtn.onclick = () => {
          manageSearch.value = "";
          updateUserKanjiListUI();
          manageJsonArea.value = "";
          openModal(manageModal);
        };

        closeManage.onclick = () => {
          closeModal(manageModal);
        };

        manageSearch.addEventListener("input", () => {
          updateUserKanjiListUI(manageSearch.value);
        });

        exportJsonBtn.onclick = () => {
          const json = JSON.stringify(userKanji, null, 2);
          manageJsonArea.value = json;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(json).then(
              () => {
                alert("ƒê√£ copy JSON c√°c Kanji ƒë√£ th√™m v√†o clipboard!");
              },
              () => {}
            );
          }
        };

        importJsonBtn.onclick = () => {
          if (!manageJsonArea.value.trim()) {
            alert("H√£y d√°n JSON v√†o √¥ ph√≠a d∆∞·ªõi tr∆∞·ªõc.");
            return;
          }
          try {
            const parsed = JSON.parse(manageJsonArea.value);
            if (!Array.isArray(parsed)) {
              alert("JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (c·∫ßn l√† m·∫£ng []).");
              return;
            }
            if (
              !confirm(
                "Vi·ªác nh·∫≠p JSON s·∫Ω thay th·∫ø to√†n b·ªô Kanji do b·∫°n th√™m hi·ªán t·∫°i. Ti·∫øp t·ª•c?"
              )
            )
              return;
            userKanji = parsed;
            saveUserKanji(userKanji);
            rebuildData();
            updateUserKanjiListUI(manageSearch.value);
            alert("‚úî ƒê√£ nh·∫≠p JSON th√†nh c√¥ng!");
          } catch (e) {
            alert("L·ªói khi parse JSON: " + e.message);
          }
        };

        clearUserBtn.onclick = () => {
          if (!confirm("Xo√° to√†n b·ªô Kanji do b·∫°n th√™m?")) return;
          userKanji = [];
          saveUserKanji(userKanji);
          rebuildData();
          updateUserKanjiListUI(manageSearch.value);
          alert("ƒê√£ xo√° to√†n b·ªô Kanji ƒë√£ th√™m.");
        };

        // Kh·ªüi t·∫°o form l·∫ßn ƒë·∫ßu
        resetKanjiForm();

        // B·∫Øt ƒë·∫ßu quiz
        startQuiz(MODE_KANJI_MEANING);
      });
    </script>
  </body>
</html>
